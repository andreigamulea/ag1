<%= render 'shared/noindex' %>
<div class="cart-container">
  <h1>Coșul tău</h1>

  <!-- Lista articolelor din coș -->
  <% if @cart_items.any? %>
    <%= form_tag update_all_cart_index_path, method: :post, class: "cart-form", data: { turbo: false } do %>
      <section class="cart-items">
        <ul class="cart-item-list">
          <% @cart_items.each do |item| %>
            <li class="cart-item">
              <div class="cart-item-details">
                <span class="cart-item-name">
                  <%= link_to item[:product].name, item[:product]&.persisted? ? carti_path(item[:product]) : root_path, class: "product-link", data: { turbo: false } %>
                  <% if item[:variant] %>
                    <small class="cart-variant-info"><%= item[:variant].options_text %></small>
                  <% end %>
                </span>

                <!-- Counter pentru cantitate -->
                <div class="quantity-counter">
                  <button type="button" class="qty-btn qty-minus" data-cart-key="<%= item[:cart_key] %>">−</button>
                  <%= number_field_tag "quantities[#{item[:cart_key]}]",
                      item[:quantity],
                      min: 1,
                      class: "qty-input",
                      data: { cart_key: item[:cart_key] } %>
                  <button type="button" class="qty-btn qty-plus" data-cart-key="<%= item[:cart_key] %>">+</button>
                </div>

                <span class="cart-item-price">
                  x <%= number_to_currency(item[:unit_price], unit: "lei", format: "%n %u") %>
                </span>
                <span class="cart-item-subtotal">
                  = <%= number_to_currency(item[:subtotal], unit: "lei", format: "%n %u") %>
                </span>
              </div>
              <button type="button"
                      class="btn btn-danger cart-item-delete"
                      data-cart-key="<%= item[:cart_key] %>"
                      data-remove-product>X</button>
            </li>
          <% end %>
        </ul>
        
        <!-- Butonul Actualizează Coșul mutat cât mai la dreapta -->
        <div class="update-cart-container">
          <%= submit_tag "ACTUALIZEAZĂ COȘUL", class: "btn btn-update" %>
        </div>
      </section>
    <% end %>
  <% else %>
    <p class="empty-cart">Coșul este gol.</p>
  <% end %>

  <!-- Sumarul coșului -->
  <section class="cart-summary">
    <p><strong>Subtotal:</strong> <%= number_to_currency(@subtotal, unit: "lei", format: "%n %u") %></p>
    <% if @discount.positive? %>
      <p><strong>Reducere:</strong> -<%= number_to_currency(@discount, unit: "lei", format: "%n %u") %></p>
    <% end %>
    <% if @shipping_cost.positive? %>
      <p><strong>Transport:</strong> <%= number_to_currency(@shipping_cost, unit: "lei", format: "%n %u") %></p>
    <% elsif @has_physical %>
      <p><strong>Transport:</strong> <span class="free-shipping">Gratuit (comandă peste 200 lei)</span></p>
    <% end %>
    <p><strong>Total de plată:</strong> <%= number_to_currency(@total, unit: "lei", format: "%n %u") %></p>
  </section>

  <!-- Secțiunea pentru aplicarea cuponului -->
  <section class="coupon-section">
    <h3>Aplică un cupon de reducere</h3>
    <%= form_with url: apply_coupon_path, method: :post, local: true, class: "coupon-form" do |f| %>
      <div class="form-group">
        <%= f.label :code, "Cod cupon:", class: "form-label" %>
        <%= f.text_field :code, required: true, class: "form-input", placeholder: "Introdu codul" %>
        <%= f.submit "Aplică cuponul", class: "btn btn-success" %>
      </div>
    <% end %>
  </section>

  <!-- Mesaj pentru cupon aplicat și erori -->
  <% if session[:applied_coupon] %>
    <div class="coupon-message">
      <p>
        Cupon: <strong><%= session[:applied_coupon]["code"] %></strong>
        <% if @discount.positive? %>
          ✅ aplicat – reducere
          <% if session[:applied_coupon]["discount_type"] == "percentage" %>
            <%= session[:applied_coupon]["discount_value"] %>%
          <% else %>
            <%= number_to_currency(@discount, unit: "lei", format: "%n %u") %>
          <% end %>
          (<%= number_to_currency(@discount, unit: "lei", format: "%n %u") %>)
        <% else %>
          – nu se aplică în prezent.
        <% end %>
      </p>
      <%= button_to "Șterge cupon", remove_coupon_path, method: :post, class: "btn btn-danger btn-remove-coupon" %>
    </div>

    <% if @coupon_errors.any? %>
      <div class="coupon-errors">
        <p><strong>Motive pentru care reducerea nu se aplică:</strong></p>
        <ul>
          <% @coupon_errors.each do |error| %>
            <li><%= error %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
  <% elsif @coupon_errors.any? %>
    <div class="coupon-errors">
      <p><strong>Motive pentru care cuponul nu poate fi aplicat:</strong></p>
      <ul>
        <% @coupon_errors.each do |error| %>
          <li><%= error %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Butoane pentru continuarea cumpărăturilor și finalizarea comenzii -->
  <!-- Butoane pentru continuarea cumpărăturilor și finalizarea comenzii -->
<div class="checkout-container">
  <% if @cart_items.any? %>
    <%= link_to "Finalizează comanda", new_order_path, class: "btn btn-primary checkout-btn" %>
  <% end %>
  <%= link_to "Continuă cumpărăturile", carti_index_path, class: "btn btn-primary btn-green continue-shopping-btn" %>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // +/- buttons use data-cart-key
  const qtyMinusButtons = document.querySelectorAll('.qty-minus');
  const qtyPlusButtons = document.querySelectorAll('.qty-plus');

  qtyMinusButtons.forEach(function(btn) {
    const newButton = btn.cloneNode(true);
    btn.parentNode.replaceChild(newButton, btn);
    newButton.addEventListener('click', function(e) {
      e.preventDefault();
      const cartKey = this.dataset.cartKey;
      const input = document.querySelector('input[data-cart-key="' + cartKey + '"]');
      const val = parseInt(input.value) || 1;
      if (val > 1) input.value = val - 1;
    });
  });

  qtyPlusButtons.forEach(function(btn) {
    const newButton = btn.cloneNode(true);
    btn.parentNode.replaceChild(newButton, btn);
    newButton.addEventListener('click', function(e) {
      e.preventDefault();
      const cartKey = this.dataset.cartKey;
      const input = document.querySelector('input[data-cart-key="' + cartKey + '"]');
      input.value = (parseInt(input.value) || 1) + 1;
    });
  });

  // AJAX form submit
  const form = document.querySelector('.cart-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      fetch(this.action, {
        method: 'POST',
        headers: { 'X-CSRF-Token': csrfToken, 'Accept': 'application/json' },
        body: formData,
        credentials: 'same-origin'
      }).then(function(response) {
        if (response.ok) window.location.reload();
        else alert('Eroare la actualizare.');
      });
    });
  }

  // Remove buttons use data-cart-key
  const removeButtons = document.querySelectorAll('[data-remove-product]');
  removeButtons.forEach(function(btn) {
    const newButton = btn.cloneNode(true);
    btn.parentNode.replaceChild(newButton, btn);
    newButton.removeAttribute('data-confirm');
    newButton.addEventListener('click', function(e) {
      e.preventDefault();
      const cartKey = this.dataset.cartKey;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      fetch('/cart/remove', {
        method: 'POST',
        headers: { 'X-CSRF-Token': csrfToken, 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ cart_key: cartKey }),
        credentials: 'same-origin'
      }).then(function(response) {
        if (response.ok) window.location.reload();
        else alert('Eroare la stergere.');
      });
    });
  });
});
</script>