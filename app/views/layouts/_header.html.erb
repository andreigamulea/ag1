<script>
/**
 * Mobile Menu Handler
 * Professional implementation with proper state management
 */

function setupMobileMenu() {
  const hamburger = document.getElementById("hamburger");
  const navWrapper = document.getElementById("nav-wrapper");
  const closeBtn = document.getElementById("close-menu");
  
  // Verificare existenÈ›Äƒ elemente
  if (!hamburger || !navWrapper || !closeBtn) {
    console.warn('Mobile menu elements not found');
    return () => {};
  }

  /**
   * Deschide meniul mobil
   */
  const openMenu = () => {
    navWrapper.classList.add("open");
    document.body.classList.add("menu-open");
    
    // Accessibility
    hamburger.setAttribute('aria-expanded', 'true');
    navWrapper.setAttribute('aria-hidden', 'false');
    
    // Focus pe butonul de Ã®nchidere
    closeBtn.focus();
  };

  /**
   * Ãnchide meniul mobil
   */
  const closeMenu = () => {
    navWrapper.classList.remove("open");
    document.body.classList.remove("menu-open");
    
    // Accessibility
    hamburger.setAttribute('aria-expanded', 'false');
    navWrapper.setAttribute('aria-hidden', 'true');
    
    // ReturneazÄƒ focus-ul la hamburger
    hamburger.focus();
  };

  /**
   * Event Handlers
   */
  
  // Click pe hamburger
  const handleHamburgerClick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    openMenu();
  };

  // Click pe butonul X
  const handleCloseClick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    closeMenu();
  };

  // Taste (Escape pentru Ã®nchidere)
  const handleKeyDown = (e) => {
    if (e.key === 'Escape' && navWrapper.classList.contains("open")) {
      e.preventDefault();
      closeMenu();
    }
  };

  // Click pe link-uri din meniu
  const handleLinkClick = () => {
    // Delay mic pentru a permite navigarea
    setTimeout(closeMenu, 150);
  };

  /**
   * AtaÈ™are event listeners
   */
  hamburger.addEventListener('click', handleHamburgerClick);
  closeBtn.addEventListener('click', handleCloseClick);
  document.addEventListener('keydown', handleKeyDown);

  // AtaÈ™are pe toate link-urile È™i butoanele din meniu
  const menuLinks = navWrapper.querySelectorAll('a, .link-button, button');
  menuLinks.forEach(link => {
    link.addEventListener('click', handleLinkClick);
  });

  /**
   * IniÈ›ializare atribute accessibility
   */
  hamburger.setAttribute('aria-expanded', 'false');
  hamburger.setAttribute('aria-controls', 'nav-wrapper');
  hamburger.setAttribute('aria-label', 'Deschide meniul');
  
  closeBtn.setAttribute('aria-label', 'Ãnchide meniul');
  
  navWrapper.setAttribute('aria-hidden', 'true');

  /**
   * Cleanup function pentru a elimina event listeners
   */
  return () => {
    hamburger.removeEventListener('click', handleHamburgerClick);
    closeBtn.removeEventListener('click', handleCloseClick);
    document.removeEventListener('keydown', handleKeyDown);
    
    menuLinks.forEach(link => {
      link.removeEventListener('click', handleLinkClick);
    });
  };
}

/**
 * Account Dropdown Handler
 */
function setupAccountDropdown() {
  const accountToggle = document.getElementById('account-toggle');
  const accountDropdown = document.getElementById('account-dropdown');
  
  if (!accountToggle || !accountDropdown) return;

  // Toggle dropdown
  accountToggle.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    accountDropdown.classList.toggle('show');
  });

  // Ãnchide dropdown cÃ¢nd se dÄƒ click Ã®n afarÄƒ
  document.addEventListener('click', (e) => {
    if (!accountToggle.contains(e.target) && !accountDropdown.contains(e.target)) {
      accountDropdown.classList.remove('show');
    }
  });

  // Ãnchide cu Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      accountDropdown.classList.remove('show');
    }
  });
}

/**
 * IniÈ›ializare meniu
 */
let cleanupFunction = () => {};

function initMenu() {
  // CurÄƒÈ›Äƒ event listeners anteriori
  cleanupFunction();
  
  // Setup nou È™i salveazÄƒ cleanup function
  cleanupFunction = setupMobileMenu();
  
  // Setup account dropdown
  setupAccountDropdown();
}

/**
 * Pornire la Ã®ncÄƒrcarea paginii
 */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMenu);
} else {
  initMenu();
}

/**
 * Re-iniÈ›ializare la resize pentru a preveni probleme
 */
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    // Ãnchide meniul dacÄƒ trecem la desktop
    if (window.innerWidth > 922) {
      const navWrapper = document.getElementById("nav-wrapper");
      if (navWrapper && navWrapper.classList.contains("open")) {
        navWrapper.classList.remove("open");
        document.body.classList.remove("menu-open");
      }
    }
  }, 250);
});
</script>

<div class="header_container">
  <header>
    <!-- Sigla principalÄƒ -->
    <a href="/" class="navbar-brand">
      <img src="<%= image_path('Ayus Grup.webp') %>" alt="Ayus Cell Romania" class="logo" />
    </a>

    <!-- FORMULAR DE CÄ‚UTARE - DESKTOP -->
    <div class="search-box">
      <%= form_with url: search_index_path, method: :get, local: true, class: "search-form" do %>
        <%= text_field_tag :q, params[:q], 
            placeholder: "CautÄƒ produse...", 
            class: "search-input",
            autocomplete: "off" %>
        <%= button_tag type: "submit", class: "search-button" do %>
          ğŸ”
        <% end %>
      <% end %>
    </div>

    <!-- Buton hamburger pentru mobil -->
    <button class="hamburger" id="hamburger" aria-label="Deschide meniul">&#9776;</button>

    <!-- Meniu principal -->
    <div class="nav-wrapper" id="nav-wrapper">
      <!-- Sigla duplicatÄƒ pentru mobil -->
      <div class="mobile-logo">
        <a href="/">
          <img src="<%= image_path('Ayus Grup.webp') %>" alt="Ayus Cell Romania" />
        </a>
      </div>

      <!-- FORMULAR DE CÄ‚UTARE - MOBIL -->
      <div class="mobile-search">
        <%= form_with url: search_index_path, method: :get, local: true, class: "search-form" do %>
          <%= text_field_tag :q, params[:q], 
              placeholder: "CautÄƒ produse...", 
              class: "search-input",
              autocomplete: "off" %>
          <%= button_tag type: "submit", class: "search-button" do %>
            ğŸ”
          <% end %>
        <% end %>
      </div>

      <nav>
        <%= link_to "AcasÄƒ", root_path %>
        <%= link_to "CÄƒrÈ›i", carti_index_path, class: "admin-link" %>
        <%= link_to "Contact", contact_path, class: "admin-link" %>

        <% if current_user %>
          <!-- Dropdown pentru Cont -->
          <div class="account-menu">
            <button class="account-toggle" id="account-toggle">
              ğŸ‘¤ Cont <span class="arrow">â–¼</span>
            </button>
            <div class="account-dropdown" id="account-dropdown">
              <div class="user-info">
                <%= current_user.email %>
              </div>
              
              <%= link_to "ğŸ‘¤ Contul meu", edit_user_registration_path %>
              <%= link_to "ğŸ“¦ Comenzile mele", orders_path %>
              <%= link_to "ğŸ“„ Facturile mele", orders_path %>
              
              <% if current_user.role == 1 %>
                <div class="divider"></div>
                <%= link_to "âš™ï¸ Admin", admin_path %>
              <% end %>
              
              <div class="divider"></div>
              <%= button_to "ğŸšª Logout", destroy_user_session_path,
                  method: :delete,
                  form: { style: "margin: 0;" } %>
            </div>
          </div>
        <% else %>
          <%= link_to "Login", new_user_session_path %>
        <% end %> 

        <% if @shipping_cost == 0 && @cart_items_count.to_i > 0 %>
          <p style="color: green; font-size: 12px; margin-top: 2px;">ğŸ Transport gratuit!</p>
        <% end %>

        <!-- CoÈ™ul de cumpÄƒrÄƒturi -->
        <%= link_to cart_index_path, style: "display: inline-block; background-color: #ffa500; color: white; padding: 10px 15px; border-radius: 6px; position: relative;" do %>
          <span style="position: absolute; top: -5px; left: 5px; background-color: white; color: #ffa500; font-size: 12px; padding: 2px 5px; border-radius: 50%;">
            <%= @cart_items_count || 0 %>
          </span>
          ğŸ›’ 
          <%= number_to_currency(@cart_total || 0, unit: "lei", format: "%n %u") %>
        <% end %>
      </nav>

      <!-- Buton Ã®nchidere meniu pe mobil -->
      <button class="close-menu" id="close-menu" aria-label="Ãnchide meniul">&times;</button>
    </div>
  </header>
</div>