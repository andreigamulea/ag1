<script>
/**
 * Mobile Menu Handler
 * Professional implementation with proper state management
 */

function setupMobileMenu() {
  const hamburger = document.getElementById("hamburger");
  const navWrapper = document.getElementById("nav-wrapper");
  const closeBtn = document.getElementById("close-menu");
  
  // Verificare existen»õƒÉ elemente
  if (!hamburger || !navWrapper || !closeBtn) {
    console.warn('Mobile menu elements not found');
    return () => {};
  }

  /**
   * Deschide meniul mobil
   */
  const openMenu = () => {
    navWrapper.classList.add("open");
    document.body.classList.add("menu-open");
    
    // Accessibility
    hamburger.setAttribute('aria-expanded', 'true');
    navWrapper.setAttribute('aria-hidden', 'false');
    
    // Focus pe butonul de √Ænchidere
    closeBtn.focus();
  };

  /**
   * √énchide meniul mobil
   */
  const closeMenu = () => {
    navWrapper.classList.remove("open");
    document.body.classList.remove("menu-open");
    
    // Accessibility
    hamburger.setAttribute('aria-expanded', 'false');
    navWrapper.setAttribute('aria-hidden', 'true');
    
    // ReturneazƒÉ focus-ul la hamburger
    hamburger.focus();
  };

  /**
   * Event Handlers
   */
  
  // Click pe hamburger
  const handleHamburgerClick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    openMenu();
  };

  // Click pe butonul X
  const handleCloseClick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    closeMenu();
  };

  // Taste (Escape pentru √Ænchidere)
  const handleKeyDown = (e) => {
    if (e.key === 'Escape' && navWrapper.classList.contains("open")) {
      e.preventDefault();
      closeMenu();
    }
  };

  // Click pe link-uri din meniu
  const handleLinkClick = () => {
    // Delay mic pentru a permite navigarea
    setTimeout(closeMenu, 150);
  };

  /**
   * Ata»ôare event listeners
   */
  hamburger.addEventListener('click', handleHamburgerClick);
  closeBtn.addEventListener('click', handleCloseClick);
  document.addEventListener('keydown', handleKeyDown);

  // Ata»ôare pe toate link-urile »ôi butoanele din meniu
  const menuLinks = navWrapper.querySelectorAll('a, .link-button, button');
  menuLinks.forEach(link => {
    link.addEventListener('click', handleLinkClick);
  });

  /**
   * Ini»õializare atribute accessibility
   */
  hamburger.setAttribute('aria-expanded', 'false');
  hamburger.setAttribute('aria-controls', 'nav-wrapper');
  hamburger.setAttribute('aria-label', 'Deschide meniul');
  
  closeBtn.setAttribute('aria-label', '√énchide meniul');
  
  navWrapper.setAttribute('aria-hidden', 'true');

  /**
   * Cleanup function pentru a elimina event listeners
   */
  return () => {
    hamburger.removeEventListener('click', handleHamburgerClick);
    closeBtn.removeEventListener('click', handleCloseClick);
    document.removeEventListener('keydown', handleKeyDown);
    
    menuLinks.forEach(link => {
      link.removeEventListener('click', handleLinkClick);
    });
  };
}

/**
 * Account Dropdown Handler
 */
function setupAccountDropdown() {
  const accountToggle = document.getElementById('account-toggle');
  const accountDropdown = document.getElementById('account-dropdown');
  
  if (!accountToggle || !accountDropdown) return;

  // Toggle dropdown
  accountToggle.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    accountDropdown.classList.toggle('show');
  });

  // √énchide dropdown c√¢nd se dƒÉ click √Æn afarƒÉ
  document.addEventListener('click', (e) => {
    if (!accountToggle.contains(e.target) && !accountDropdown.contains(e.target)) {
      accountDropdown.classList.remove('show');
    }
  });

  // √énchide cu Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      accountDropdown.classList.remove('show');
    }
  });
}

/**
 * Ini»õializare meniu
 */
let cleanupFunction = () => {};

function initMenu() {
  // CurƒÉ»õƒÉ event listeners anteriori
  cleanupFunction();
  
  // Setup nou »ôi salveazƒÉ cleanup function
  cleanupFunction = setupMobileMenu();
  
  // Setup account dropdown
  setupAccountDropdown();
}

/**
 * Pornire la √ÆncƒÉrcarea paginii
 */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMenu);
} else {
  initMenu();
}

/**
 * Re-ini»õializare la resize pentru a preveni probleme
 */
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    // √énchide meniul dacƒÉ trecem la desktop
    if (window.innerWidth > 922) {
      const navWrapper = document.getElementById("nav-wrapper");
      if (navWrapper && navWrapper.classList.contains("open")) {
        navWrapper.classList.remove("open");
        document.body.classList.remove("menu-open");
      }
    }
  }, 250);
});
</script>

<style>
/* ============================================
   HEADER PRINCIPAL
   ============================================ */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 30px;
  background-color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  gap: 20px;
}

.navbar-brand {
  flex-shrink: 0;
}

.navbar-brand .logo {
  height: 60px;
  width: auto;
}

/* ============================================
   SEARCH BOX STYLES
   ============================================ */

/* Search box pentru desktop */
.search-box {
  flex: 1;
  max-width: 500px;
  margin: 0 20px;
  display: flex;
}

.search-form {
  width: 100%;
  display: flex;
  gap: 5px;
}

.search-input {
  flex: 1;
  padding: 10px 15px;
  border: 2px solid #8b0000;
  border-radius: 25px;
  font-size: 14px;
  font-family: 'Lora', serif;
  outline: none;
  transition: all 0.3s ease;
}

.search-input:focus {
  border-color: #6d0000;
  box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
}

.search-button {
  background-color: #8b0000;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-button:hover {
  background-color: #6d0000;
}

/* Search box pentru mobil - ascuns pe desktop */
.mobile-search {
  display: none;
}

/* ============================================
   ACCOUNT DROPDOWN STYLES
   ============================================ */
.account-menu {
  position: relative;
  display: inline-block;
}

.account-toggle {
  background: none;
  border: none;
  color: #8b0000;
  font-size: 16px;
  font-family: 'Lora', serif;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
  padding: 0;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  text-decoration: none;
  transition: color 0.3s ease;
}

.account-toggle:hover {
  color: #6d0000;
}

.account-toggle .arrow {
  font-size: 0.7em;
  margin-left: 2px;
}

.account-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 220px;
  z-index: 1000;
  margin-top: 8px;
}

.account-dropdown.show {
  display: block;
}

.account-dropdown a,
.account-dropdown button {
  display: block;
  width: 100%;
  padding: 12px 20px;
  color: #333;
  text-decoration: none;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  font-family: 'Lora', serif;
  font-size: 14px;
  font-weight: normal;
  text-transform: none;
  letter-spacing: normal;
  transition: background 0.2s;
}

.account-dropdown a:hover,
.account-dropdown button:hover {
  background: #f8f9fa;
  color: #8b0000;
}

.account-dropdown .divider {
  height: 1px;
  background: #e9ecef;
  margin: 5px 0;
}

.account-dropdown .user-info {
  padding: 12px 20px;
  border-bottom: 1px solid #e9ecef;
  font-size: 13px;
  color: #6c757d;
  font-weight: 500;
}

.account-dropdown form {
  margin: 0;
}

/* ============================================
   MOBILE RESPONSIVE
   ============================================ */

@media (max-width: 922px) {
  /* Ascunde search box-ul de pe desktop */
  .search-box {
    display: none;
  }
  
  /* AratƒÉ search box-ul √Æn meniul mobil */
  .mobile-search {
    display: block;
    padding: 15px 20px;
    border-bottom: 1px solid rgba(139, 0, 0, 0.2);
  }
  
  .mobile-search .search-form {
    width: 100%;
  }
  
  .mobile-search .search-input {
    width: 100%;
  }
  
  /* Account menu adjustments */
  .account-menu {
    width: 100%;
  }
  
  .account-toggle {
    width: 100%;
    justify-content: flex-start;
    padding: 5px 0;
  }
  
  .account-dropdown {
    position: static;
    box-shadow: none;
    border: none;
    border-left: 3px solid #8b0000;
    margin-left: 15px;
    margin-top: 5px;
    background: rgba(139, 0, 0, 0.05);
  }
  
  .account-dropdown.show {
    display: block;
  }
}

@media (max-width: 768px) {
  header {
    padding: 15px 20px;
  }
  
  .search-input {
    font-size: 13px;
    padding: 8px 12px;
  }
  
  .search-button {
    padding: 8px 15px;
    font-size: 14px;
  }
}
</style>

<div class="header_container">
  <header>
    <!-- Sigla principalƒÉ -->
    <a href="/" class="navbar-brand">
      <img src="<%= image_path('Ayus Grup.webp') %>" alt="Ayus Cell Romania" class="logo" />
    </a>

    <!-- FORMULAR DE CƒÇUTARE - DESKTOP -->
    <div class="search-box">
      <%= form_with url: search_index_path, method: :get, local: true, class: "search-form" do %>
        <%= text_field_tag :q, params[:q], 
            placeholder: "CautƒÉ produse...", 
            class: "search-input",
            autocomplete: "off" %>
        <%= button_tag type: "submit", class: "search-button" do %>
          üîç
        <% end %>
      <% end %>
    </div>

    <!-- Buton hamburger pentru mobil -->
    <button class="hamburger" id="hamburger" aria-label="Deschide meniul">&#9776;</button>

    <!-- Meniu principal -->
    <div class="nav-wrapper" id="nav-wrapper">
      <!-- Sigla duplicatƒÉ pentru mobil -->
      <div class="mobile-logo">
        <a href="/">
          <img src="<%= image_path('Ayus Grup.webp') %>" alt="Ayus Cell Romania" />
        </a>
      </div>

      <!-- FORMULAR DE CƒÇUTARE - MOBIL -->
      <div class="mobile-search">
        <%= form_with url: search_index_path, method: :get, local: true, class: "search-form" do %>
          <%= text_field_tag :q, params[:q], 
              placeholder: "CautƒÉ produse...", 
              class: "search-input",
              autocomplete: "off" %>
          <%= button_tag type: "submit", class: "search-button" do %>
            üîç
          <% end %>
        <% end %>
      </div>

      <nav>
        <%= link_to "AcasƒÉ", root_path %>
        <%= link_to "CƒÉr»õi", carti_index_path, class: "admin-link" %>
        <%= link_to "Contact", contact_path, class: "admin-link" %>

        <% if current_user %>
          <!-- Dropdown pentru Cont -->
          <div class="account-menu">
            <button class="account-toggle" id="account-toggle">
              üë§ Cont <span class="arrow">‚ñº</span>
            </button>
            <div class="account-dropdown" id="account-dropdown">
              <div class="user-info">
                <%= current_user.email %>
              </div>
              
              <%= link_to "üë§ Contul meu", edit_user_registration_path %>
              <%= link_to "üì¶ Comenzile mele", orders_path %>
              <%= link_to "üìÑ Facturile mele", orders_path %>
              
              <% if current_user.role == 1 %>
                <div class="divider"></div>
                <%= link_to "‚öôÔ∏è Admin", admin_path %>
              <% end %>
              
              <div class="divider"></div>
              <%= button_to "üö™ Logout", destroy_user_session_path,
                  method: :delete,
                  form: { style: "margin: 0;" } %>
            </div>
          </div>
        <% else %>
          <%= link_to "Login", new_user_session_path %>
        <% end %> 

        <% if @shipping_cost == 0 && @cart_items_count.to_i > 0 %>
          <p style="color: green; font-size: 12px; margin-top: 2px;">üéÅ Transport gratuit!</p>
        <% end %>

        <!-- Co»ôul de cumpƒÉrƒÉturi -->
        <%= link_to cart_index_path, style: "display: inline-block; background-color: #ffa500; color: white; padding: 10px 15px; border-radius: 6px; position: relative;" do %>
          <span style="position: absolute; top: -5px; left: 5px; background-color: white; color: #ffa500; font-size: 12px; padding: 2px 5px; border-radius: 50%;">
            <%= @cart_items_count || 0 %>
          </span>
          üõí 
          <%= number_to_currency(@cart_total || 0, unit: "lei", format: "%n %u") %>
        <% end %>
      </nav>

      <!-- Buton √Ænchidere meniu pe mobil -->
      <button class="close-menu" id="close-menu" aria-label="√énchide meniul">&times;</button>
    </div>
  </header>
</div>