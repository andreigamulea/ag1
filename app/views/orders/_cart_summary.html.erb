<h2>Rezumat comandă</h2>

<table>
  <tr>
    <th>Produs</th>
    <th>Cant.</th>
    <th>Preț</th>
    <th>Total</th>
  </tr>
  <% @cart.each do |cart_key, data| %>
    <% parsed = parse_cart_key(cart_key) %>
    <% product = Product.find_by(id: parsed[:product_id]) %>
    <% next unless product %>
    <% variant = parsed[:variant_id] ? Variant.find_by(id: parsed[:variant_id]) : nil %>
    <% quantity = data["quantity"].to_i %>
    <% unit_price = variant&.effective_price || product.effective_price || 0 %>
    <tr>
      <td>
        <%= product.name %>
        <% if variant %>
          <br><small style="color: #666;"><%= variant.options_text %></small>
        <% end %>
      </td>
      <td><%= quantity %></td>
      <td><%= number_to_currency(unit_price, unit: "") %> lei</td>
      <td><%= number_to_currency(unit_price * quantity, unit: "") %> lei</td>
    </tr>
  <% end %>
</table>

<p><strong>Subtotal:</strong> <%= number_to_currency(@subtotal, unit: "") %> lei</p>

<% if @discount.positive? %>
  <p style="color: green;">✅ Discount: -<%= number_to_currency(@discount, unit: "") %> lei</p>
<% end %>

<% if @shipping_cost > 0 %>
  <p><strong>Transport:</strong> <%= number_to_currency(@shipping_cost, unit: "") %> lei</p>
<% else %>
  <p><strong>Transport:</strong> Gratuit</p>
<% end %>

<p><strong>Total estimat:</strong> <%= number_to_currency(@total, unit: "") %> lei</p>
