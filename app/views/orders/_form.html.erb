<style>
.dropdown-menu {
  border: 1px solid #ccc;
  background-color: white;
  max-height: 200px;
  overflow-y: auto;
  position: absolute;
  z-index: 1000;
  width: 100%;
}
.dropdown-item {
  padding: 8px;
  cursor: pointer;
}
.dropdown-item:hover {
  background-color: #f0f0f0;
}
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 10px;
}
.col {
  flex: 1;
  min-width: 200px;
}
</style>

<%= form_with model: @order, url: orders_path, method: :post, local: true do |f| %>
  <% if @order.errors.any? %>
    <div class="alert alert-danger">
      <h4><strong>Comanda nu a putut fi salvată:</strong></h4>
      <ul>
        <% @order.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <fieldset>
    <legend><strong>Date de facturare</strong></legend>

    <div class="row">
      <div class="col"><%= f.label :first_name, "Prenume" %><br><%= f.text_field :first_name, required: true %></div>
      <div class="col"><%= f.label :last_name, "Nume" %><br><%= f.text_field :last_name, required: true %></div>
    </div>

    <div class="row">
      <div class="col"><%= f.label :company_name, "Companie (opțional)" %><br><%= f.text_field :company_name %></div>
      <div class="col"><%= f.label :cui, "CUI (opțional)" %><br><%= f.text_field :cui %></div>
    </div>

    <div class="row">
      <div class="col"><%= f.label :cnp, "CNP" %><br><%= f.text_field :cnp, placeholder: "0000000000000" %></div>
      <div class="col"><%= f.label :phone, "Telefon" %><br><%= f.telephone_field :phone, required: true %></div>
    </div>

    <div class="row">
      <div class="col"><%= f.label :email, "Email" %><br><%= f.email_field :email, required: true %></div>
    </div>

    <div class="mb-3">
      <%= f.label :country, "Țara", class: "form-label" %>
      <div class="position-relative">
        <%= f.text_field :country, class: "form-control", id: "tara_input", placeholder: "Click pentru a schimba țara...", autocomplete: "off", value: "Romania" %>
        <div id="tara_dropdown" class="dropdown-menu w-100 shadow"></div>
      </div>
    </div>

    <div class="mb-3">
      <%= f.label :county, "Județ", class: "form-label" %>
      <div class="position-relative">
        <%= f.text_field :county, class: "form-control", id: "judet_input", placeholder: "Tastează max 2 litere...", autocomplete: "off", disabled: false %>
        <div id="judet_dropdown" class="dropdown-menu w-100 shadow"></div>
      </div>
    </div>

    <div class="mb-3">
      <%= f.label :city, "Localitate", class: "form-label" %>
      <div class="position-relative">
        <%= f.text_field :city, class: "form-control", id: "localitate_input", placeholder: "Tastează max 2 litere...", autocomplete: "off", disabled: true %>
        <div id="localitate_dropdown" class="dropdown-menu w-100 shadow"></div>
      </div>
    </div>

    <div class="row">
      <div class="col"><%= f.label :postal_code, "Cod poștal" %><br><%= f.text_field :postal_code, required: true %></div>
    </div>

    <div class="row">
      <div class="col"><%= f.label :street, "Stradă" %><br><%= f.text_field :street, required: true %></div>
      <div class="col"><%= f.label :street_number, "Număr" %><br><%= f.text_field :street_number %></div>
    </div>

    <div class="row">
      <div class="col"><%= f.label :block_details, "Bloc/Etaj/Apt (opțional)" %><br><%= f.text_field :block_details %></div>
    </div>
  </fieldset>

  <hr>

  <div data-controller="toggle-shipping">
    <div style="margin: 20px 0;">
      <div class="field">
        <%= f.check_box :use_different_shipping, id: "toggle-shipping" %>
        <%= f.label :use_different_shipping, "Adresa de livrare este diferită" %>
      </div>
    </div>

    <div id="shipping-fields" data-toggle-shipping-target="fields" style="display: none;">
      <fieldset>
        <legend><strong>Date de livrare</strong></legend>

        <div class="row">
          <div class="col"><%= f.label :shipping_first_name, "Prenume livrare" %><br><%= f.text_field :shipping_first_name %></div>
          <div class="col"><%= f.label :shipping_last_name, "Nume livrare" %><br><%= f.text_field :shipping_last_name %></div>
        </div>

        <div class="row">
          <div class="col"><%= f.label :shipping_company_name, "Companie livrare" %><br><%= f.text_field :shipping_company_name %></div>
        </div>

        <div class="mb-3">
          <%= f.label :shipping_country, "Țara livrare", class: "form-label" %>
          <div class="position-relative">
            <%= f.text_field :shipping_country, class: "form-control", id: "shipping_tara_input", placeholder: "Click pentru a schimba țara...", autocomplete: "off", value: "Romania" %>
            <div id="shipping_tara_dropdown" class="dropdown-menu w-100 shadow"></div>
          </div>
        </div>

        <div class="mb-3">
          <%= f.label :shipping_county, "Județ livrare", class: "form-label" %>
          <div class="position-relative">
            <%= f.text_field :shipping_county, class: "form-control", id: "shipping_judet_input", placeholder: "Tastează max 2 litere...", autocomplete: "off", disabled: false %>
            <div id="shipping_judet_dropdown" class="dropdown-menu w-100 shadow"></div>
          </div>
        </div>

        <div class="mb-3">
          <%= f.label :shipping_city, "Localitate livrare", class: "form-label" %>
          <div class="position-relative">
            <%= f.text_field :shipping_city, class: "form-control", id: "shipping_localitate_input", placeholder: "Tastează max 2 litere...", autocomplete: "off", disabled: true %>
            <div id="shipping_localitate_dropdown" class="dropdown-menu w-100 shadow"></div>
          </div>
        </div>

        <div class="row">
          <div class="col"><%= f.label :shipping_postal_code, "Cod poștal livrare" %><br><%= f.text_field :shipping_postal_code %></div>
        </div>

        <div class="row">
          <div class="col"><%= f.label :shipping_street, "Stradă livrare" %><br><%= f.text_field :shipping_street %></div>
          <div class="col"><%= f.label :shipping_street_number, "Număr livrare" %><br><%= f.text_field :shipping_street_number %></div>
        </div>

        <div class="row">
          <div class="col"><%= f.label :shipping_block_details, "Bloc/Etaj/Apt livrare" %><br><%= f.text_field :shipping_block_details %></div>
          <div class="col"><%= f.label :shipping_phone, "Telefon livrare" %><br><%= f.text_field :shipping_phone %></div>
        </div>
      </fieldset>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <%= f.label :notes, "Note comandă (opțional)" %><br>
      <%= f.text_area :notes, rows: 3 %>
    </div>
  </div>

  <div style="margin-top: 20px;">
    <%= f.submit "Plasează comanda", class: "btn btn-primary" %>
  </div>
<% end %>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    function setupAutocomplete(inputId, dropdownId, endpoint, filterId = null, taraInputId = "tara_input") {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      let validSuggestions = [];
      let allOptions = [];

      function updateDropdown(query, filterValue = null) {
        dropdown.innerHTML = '';
        
        let url = `${endpoint}?q=${encodeURIComponent(query)}`;
        if (filterValue) {
          url += `&filter=${encodeURIComponent(filterValue)}`;
        }
        
        fetch(url)
          .then((response) => {
            if (!response.ok) {
              console.error("Fetch error: ", response.status);
              throw new Error("Network response not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Received data for " + inputId + ": ", data);
            
            // Pentru țară, pune România prima
            if (inputId.endsWith("tara_input")) {
              const romaniaIndex = data.findIndex(item => item.toLowerCase() === "romania");
              if (romaniaIndex > -1) {
                const romania = data.splice(romaniaIndex, 1)[0];
                data.unshift(romania);
              }
            }
            
            validSuggestions = data;
            allOptions = data;
            displayOptions(data);
          })
          .catch((error) => console.error("Eroare la încărcarea sugestiilor:", error));
      }

      function displayOptions(data) {
        dropdown.innerHTML = '';
        if (data.length > 0) {
          dropdown.style.display = 'block';
          data.forEach((item) => {
            const option = document.createElement('a');
            option.classList.add('dropdown-item');
            option.textContent = item;
            option.href = '#';
            option.addEventListener('click', (e) => {
              e.preventDefault();
              input.value = item;
              dropdown.style.display = 'none';
              enableNextFields(inputId, item);
            });
            dropdown.appendChild(option);
          });
        } else {
          dropdown.style.display = 'none';
        }
      }

      // Pentru ȚARĂ: click pentru a deschide lista
      if (inputId.endsWith("tara_input")) {
        input.addEventListener('click', () => {
          input.value = '';
          disableNextFields(inputId);
          updateDropdown('a'); // Încarcă toate țările
        });

        input.addEventListener('focus', () => {
          if (input.value === '' || input.value === 'Romania') {
            updateDropdown('a');
          }
        });

        input.addEventListener('blur', () => {
          setTimeout(() => {
            if (!validSuggestions.includes(input.value)) {
              input.value = 'Romania'; // Revine la România dacă nu e selectat nimic
              enableNextFields(inputId, 'Romania');
            }
            dropdown.style.display = 'none';
          }, 200);
        });

        // Blochează tastarea pentru țară
        input.addEventListener('keydown', (e) => {
          e.preventDefault();
        });
      }

      // Pentru JUDEȚ și LOCALITATE
      if (inputId.endsWith("judet_input") || inputId.endsWith("localitate_input")) {
        const taraInput = document.getElementById(taraInputId);
        
        input.addEventListener('input', () => {
          const isRomania = taraInput && taraInput.value.trim().toLowerCase() === "romania";
          
          // Pentru ROMÂNIA: comportament cu max 2 caractere
          if (isRomania) {
            let value = input.value;
            
            // Limitează la 2 caractere
            if (value.length > 2) {
              input.value = value.substring(0, 2);
              return;
            }
            
            // Dacă are 1-2 caractere, filtrează lista
            if (value.length > 0) {
              const filterValue = filterId ? document.getElementById(filterId)?.value.trim() : null;
              updateDropdown(value, filterValue);
            } else {
              // Dacă e gol, arată toate
              const filterValue = filterId ? document.getElementById(filterId)?.value.trim() : null;
              updateDropdown('*', filterValue);
            }
          } else {
            // Pentru ALTE ȚĂRI: nu face nimic special, permite tastare liberă
            // Nu încarcă dropdown, doar lasă utilizatorul să scrie liber
          }
        });

        // La focus, pentru România arată toate opțiunile
        input.addEventListener('focus', () => {
          const isRomania = taraInput && taraInput.value.trim().toLowerCase() === "romania";
          if (isRomania) {
            const filterValue = filterId ? document.getElementById(filterId)?.value.trim() : null;
            updateDropdown('*', filterValue);
          }
        });

        // La blur, validează selecția DOAR pentru România
        input.addEventListener('blur', () => {
          setTimeout(() => {
            const isRomania = taraInput && taraInput.value.trim().toLowerCase() === "romania";
            if (isRomania) {
              const normalizedInput = input.value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
              const isValid = validSuggestions.some(sug => sug.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === normalizedInput);
              if (!isValid) {
                input.value = '';
                disableNextFields(inputId);
              }
            }
            dropdown.style.display = 'none';
          }, 200);
        });
      }

      // Click în afara dropdown-ului
      document.addEventListener('click', (event) => {
        if (!dropdown.contains(event.target) && event.target !== input) {
          dropdown.style.display = 'none';
        }
      });
    }

    function enableNextFields(inputId, value) {
      if (inputId.endsWith("tara_input")) {
        const tara = value.trim().toLowerCase();
        const prefix = inputId.startsWith("shipping_") ? "shipping_" : "";
        const judetInput = document.getElementById(`${prefix}judet_input`);
        const localitateInput = document.getElementById(`${prefix}localitate_input`);
        
        if (tara === "romania") {
          // Pentru România: autocomplete cu max 2 caractere
          judetInput.disabled = false;
          judetInput.readOnly = false;
          localitateInput.disabled = true;
          localitateInput.readOnly = false;
          judetInput.placeholder = "Tastează max 2 litere și selectează...";
          localitateInput.placeholder = "Tastează max 2 litere și selectează...";
          judetInput.style.cursor = "text";
          localitateInput.style.cursor = "text";
          judetInput.style.backgroundColor = "#fff";
          localitateInput.style.backgroundColor = "#fff";
        } else {
          // Pentru alte țări: input liber, fără autocomplete
          judetInput.disabled = false;
          judetInput.readOnly = false;
          localitateInput.disabled = false;
          localitateInput.readOnly = false;
          judetInput.placeholder = "Introduceți județul/regiunea...";
          localitateInput.placeholder = "Introduceți localitatea...";
          judetInput.style.cursor = "text";
          localitateInput.style.cursor = "text";
          judetInput.style.backgroundColor = "#fff";
          localitateInput.style.backgroundColor = "#fff";
        }
      } else if (inputId.endsWith("judet_input")) {
        const prefix = inputId.startsWith("shipping_") ? "shipping_" : "";
        const localitateInput = document.getElementById(`${prefix}localitate_input`);
        const taraInput = document.getElementById(prefix ? `${prefix}tara_input` : "tara_input");
        const isRomania = taraInput && taraInput.value.trim().toLowerCase() === "romania";
        
        localitateInput.disabled = false;
        localitateInput.style.cursor = "text";
        
        if (isRomania) {
          localitateInput.placeholder = "Tastează max 2 litere și selectează...";
        } else {
          localitateInput.placeholder = "Introduceți localitatea...";
        }
      }
    }

    function disableNextFields(inputId) {
      if (inputId.endsWith("tara_input")) {
        const prefix = inputId.startsWith("shipping_") ? "shipping_" : "";
        const judetInput = document.getElementById(`${prefix}judet_input`);
        const localitateInput = document.getElementById(`${prefix}localitate_input`);
        judetInput.disabled = true;
        judetInput.value = '';
        localitateInput.disabled = true;
        localitateInput.value = '';
      } else if (inputId.endsWith("judet_input")) {
        const prefix = inputId.startsWith("shipping_") ? "shipping_" : "";
        const localitateInput = document.getElementById(`${prefix}localitate_input`);
        localitateInput.disabled = true;
        localitateInput.value = '';
      }
    }

    function initializeFields(prefix = "") {
      const taraInput = document.getElementById(`${prefix}tara_input`);
      const judetInput = document.getElementById(`${prefix}judet_input`);
      const localitateInput = document.getElementById(`${prefix}localitate_input`);

      // Setează România by default
      if (!taraInput.value || taraInput.value === '') {
        taraInput.value = "Romania";
      }
      
      // Activează județul pentru România
      const tara = taraInput.value.trim().toLowerCase();
      if (tara === "romania") {
        judetInput.disabled = false;
        judetInput.placeholder = "Tastează max 2 litere și selectează...";
        localitateInput.placeholder = "Tastează max 2 litere și selectează...";
      } else if (tara) {
        judetInput.disabled = false;
        localitateInput.disabled = false;
        judetInput.placeholder = "Introduceți județul/regiunea...";
        localitateInput.placeholder = "Introduceți localitatea...";
      }

      // Dacă sunt precompletate, dezactivează disabled
      if (judetInput.value.trim() !== '') {
        judetInput.disabled = false;
      }
      if (localitateInput.value.trim() !== '') {
        localitateInput.disabled = false;
      }
      
      // Țara poate fi schimbată prin click
      taraInput.style.cursor = "pointer";
      taraInput.style.backgroundColor = "#f8f9fa";
    }

    // Configurează autocomplete pentru Facturare
    setupAutocomplete("tara_input", "tara_dropdown", "/autocomplete_tara");
    setupAutocomplete("judet_input", "judet_dropdown", "/autocomplete_judet");
    setupAutocomplete("localitate_input", "localitate_dropdown", "/autocomplete_localitate", "judet_input");

    // Configurează autocomplete pentru Shipping
    setupAutocomplete("shipping_tara_input", "shipping_tara_dropdown", "/autocomplete_tara", null, "shipping_tara_input");
    setupAutocomplete("shipping_judet_input", "shipping_judet_dropdown", "/autocomplete_judet", null, "shipping_tara_input");
    setupAutocomplete("shipping_localitate_input", "shipping_localitate_dropdown", "/autocomplete_localitate", "shipping_judet_input", "shipping_tara_input");

    // Inițializează starea câmpurilor la load cu România by default
    initializeFields();
    initializeFields("shipping_");
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const checkbox = document.getElementById("toggle-shipping");
    const fields = document.getElementById("shipping-fields");

    if (checkbox && fields) {
      fields.style.display = checkbox.checked ? "block" : "none";

      checkbox.addEventListener("change", () => {
        fields.style.display = checkbox.checked ? "block" : "none";
      });
    } else {
      console.error("Eroare: Checkbox sau fields nu găsit!");
    }
  });
</script>