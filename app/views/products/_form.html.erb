<style>
  .form-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .form-section {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .section-header {
    padding: 12px 20px;
    font-weight: 600;
    font-size: 15px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-header.primary { background: #4a90e2; }
  .section-header.success { background: #52c41a; }
  .section-header.info { background: #13c2c2; }
  .section-header.warning { background: #faad14; color: #000; }
  .section-header.secondary { background: #8c8c8c; }
  .section-header.dark { background: #262626; }
  .section-header.danger { background: #f5222d; }

  .section-body {
    padding: 20px;
  }

  .form-row {
    display: grid;
    gap: 15px;
    margin-bottom: 15px;
  }

  .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
  .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
  .form-row.cols-4 { grid-template-columns: repeat(4, 1fr); }
  .form-row.cols-1 { grid-template-columns: 1fr; }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-field label {
    font-size: 13px;
    font-weight: 500;
    color: #333;
  }

  .form-field input[type="text"],
  .form-field input[type="number"],
  .form-field input[type="date"],
  .form-field textarea,
  .form-field select {
    padding: 8px 12px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.3s;
  }

  .form-field input:focus,
  .form-field textarea:focus,
  .form-field select:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.1);
  }

  .form-field textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }

  .input-group {
    display: flex;
    align-items: stretch;
  }

  .input-group input {
    flex: 1;
    border-radius: 4px 0 0 4px;
  }

  .input-group-text {
    padding: 8px 12px;
    background: #fafafa;
    border: 1px solid #d9d9d9;
    border-left: none;
    border-radius: 0 4px 4px 0;
    font-size: 13px;
    color: #666;
  }

  .checkbox-field {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
  }

  .checkbox-field input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .checkbox-field label {
    font-size: 14px;
    cursor: pointer;
    margin: 0;
  }

  .category-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .category-badge {
    padding: 6px 14px;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
  }

  .category-badge.active {
    background: #4a90e2;
    color: #fff;
  }

  .category-badge.inactive {
    background: #f0f0f0;
    color: #666;
  }

  .category-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .image-preview-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
  }

  .image-preview-item {
    position: relative;
    display: inline-block;
  }

  .image-preview-item img {
    border-radius: 4px;
    border: 1px solid #e0e0e0;
  }

  .remove-btn {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #f5222d;
    color: #fff;
    border: 2px solid #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .image-preview-item:hover .remove-btn {
    opacity: 1;
  }

  .file-preview-item {
    position: relative;
    padding: 10px 12px;
    background: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .file-preview-item a {
    color: #4a90e2;
    text-decoration: none;
    font-size: 14px;
  }

  .file-preview-item .remove-btn {
    position: static;
    opacity: 1;
    margin-left: 10px;
  }

  .alert-danger {
    background: #fff2f0;
    border: 1px solid #ffccc7;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .alert-danger h4 {
    color: #f5222d;
    font-size: 15px;
    font-weight: 600;
    margin: 0 0 10px 0;
  }

  .alert-danger ul {
    margin: 0;
    padding-left: 20px;
    color: #666;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
  }

  .btn {
    padding: 10px 24px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.3s;
  }

  .btn-primary {
    background: #4a90e2;
    color: #fff;
  }

  .btn-primary:hover {
    background: #3a7bc8;
  }

  .btn-secondary {
    background: #fff;
    color: #666;
    border: 1px solid #d9d9d9;
  }

  .btn-secondary:hover {
    border-color: #4a90e2;
    color: #4a90e2;
  }

  .btn-danger {
    background: #f5222d;
    color: #fff;
  }

  .btn-danger:hover {
    background: #d9191c;
  }

  @media (max-width: 768px) {
    .form-row.cols-2,
    .form-row.cols-3,
    .form-row.cols-4 {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="form-container">
  <%= form_with(model: product, local: true, html: { multipart: true }) do |form| %>

    <% if product.errors.any? %>
      <div class="alert-danger">
        <h4>‚ö†Ô∏è <%= pluralize(product.errors.count, "error") %> prohibited this product from being saved:</h4>
        <ul>
          <% product.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Informa»õii de bazƒÉ -->
    <div class="form-section">
      <div class="section-header primary">
        üìã Informa»õii de bazƒÉ
      </div>
      <div class="section-body">
        <div class="form-row cols-2">
          <div class="form-field">
            <%= form.label :name, "Nume produs" %>
            <%= form.text_field :name, placeholder: "Nume produs" %>
          </div>
          <div class="form-field">
            <%= form.label :slug, "URL Slug" %>
            <%= form.text_field :slug, placeholder: "url-friendly-name" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :description_title, "Titlu descriere" %>
            <%= form.text_field :description_title, placeholder: "Titlu pentru sec»õiunea de descriere" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :description, "Descriere" %>
            <%= form.text_area :description, placeholder: "Descriere detaliatƒÉ a produsului..." %>
          </div>
        </div>

        <div class="form-row cols-3">
          <div class="form-field">
            <%= form.label :sku, "SKU" %>
            <%= form.text_field :sku, placeholder: "SKU-12345" %>
          </div>
          <div class="form-field">
            <%= form.label :status, "Status" %>
            <%= form.select :status, ["active", "inactive"], {}, {} %>
          </div>
          <div class="checkbox-field" style="margin-top: 24px;">
            <%= form.check_box :featured %>
            <%= form.label :featured, "Produs promovat" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Pre»õuri »ôi Taxe -->
    <div class="form-section">
      <div class="section-header success">
        üí∞ Pre»õuri »ôi Taxe
      </div>
      <div class="section-body">
        <div class="form-row cols-4">
          <div class="form-field">
            <%= form.label :price, "Pre»õ" %>
            <div class="input-group">
              <%= form.number_field :price, step: 0.01, placeholder: "0.00" %>
              <span class="input-group-text">RON</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :cost_price, "Pre»õ cost" %>
            <div class="input-group">
              <%= form.number_field :cost_price, step: 0.01, placeholder: "0.00" %>
              <span class="input-group-text">RON</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :discount_price, "Pre»õ redus" %>
            <div class="input-group">
              <%= form.number_field :discount_price, step: 0.01, placeholder: "0.00" %>
              <span class="input-group-text">RON</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :vat, "TVA" %>
            <div class="input-group">
              <%= form.number_field :vat, min: 0, placeholder: "19" %>
              <span class="input-group-text">%</span>
            </div>
          </div>
        </div>

        <div class="form-row cols-2">
          <div class="checkbox-field">
            <%= form.check_box :taxable %>
            <%= form.label :taxable, "Se aplicƒÉ TVA" %>
          </div>
          <div class="checkbox-field">
            <%= form.check_box :coupon_applicable %>
            <%= form.label :coupon_applicable, "Se aplicƒÉ cupon de reducere" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventar »ôi Stoc -->
    <div class="form-section">
      <div class="section-header info">
        üì¶ Inventar »ôi Stoc
      </div>
      <div class="section-body">
        <div class="form-row cols-3">
          <div class="form-field">
            <%= form.label :stock, "Stoc" %>
            <%= form.number_field :stock, placeholder: "0" %>
          </div>
          <div class="form-field">
            <%= form.label :stock_status, "Status stoc" %>
            <%= form.select :stock_status, Product.stock_statuses.keys.map { |k| [k.humanize, k] } %>
          </div>
          <div class="checkbox-field" style="margin-top: 24px;">
            <%= form.check_box :track_inventory %>
            <%= form.label :track_inventory, "UrmƒÉre»ôte inventarul" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="checkbox-field">
            <%= form.check_box :sold_individually %>
            <%= form.label :sold_individually, "Se vinde individual" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Dimensiuni »ôi Greutate -->
    <div class="form-section">
      <div class="section-header warning">
        üìè Dimensiuni »ôi Greutate
      </div>
      <div class="section-body">
        <div class="form-row cols-4">
          <div class="form-field">
            <%= form.label :height, "√énƒÉl»õime" %>
            <div class="input-group">
              <%= form.number_field :height, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :width, "LƒÉ»õime" %>
            <div class="input-group">
              <%= form.number_field :width, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :depth, "Ad√¢ncime" %>
            <div class="input-group">
              <%= form.number_field :depth, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :weight, "Greutate" %>
            <div class="input-group">
              <%= form.number_field :weight, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">g</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Disponibilitate -->
    <div class="form-section">
      <div class="section-header secondary">
        üìÖ Disponibilitate
      </div>
      <div class="section-body">
        <div class="form-row cols-2">
          <div class="form-field">
            <%= form.label :available_on, "Disponibil din" %>
            <%= form.date_field :available_on %>
          </div>
          <div class="form-field">
            <%= form.label :discontinue_on, "Se √Æntrerupe la" %>
            <%= form.date_field :discontinue_on %>
          </div>
        </div>
      </div>
    </div>

    <!-- ConfigurƒÉri Produs -->
    <div class="form-section">
      <div class="section-header dark">
        ‚öôÔ∏è ConfigurƒÉri Produs
      </div>
      <div class="section-body">
        <div class="form-row cols-2">
          <div class="form-field">
            <%= form.label :product_type, "Tip produs" %>
            <%= form.select :product_type, Product.product_types.keys.map { |t| [t.titleize, t] } %>
          </div>
          <div class="form-field">
            <%= form.label :delivery_method, "Mod de livrare" %>
            <%= form.select :delivery_method, Product.delivery_methods.keys.map { |k| [k.titleize, k] } %>
          </div>
        </div>

        <div class="form-row cols-2">
          <div class="checkbox-field">
            <%= form.check_box :requires_login %>
            <%= form.label :requires_login, "Doar utilizatori loga»õi pot cumpƒÉra" %>
          </div>
          <div class="checkbox-field">
            <%= form.check_box :visible_to_guests %>
            <%= form.label :visible_to_guests, "Vizibil pentru utilizatori neautentifica»õi" %>
          </div>
        </div>
      </div>
    </div>

    <!-- SEO »ôi Metadata -->
    <div class="form-section">
      <div class="section-header primary">
        üîç SEO »ôi Metadata
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :meta_title, "Titlu SEO" %>
            <%= form.text_field :meta_title, placeholder: "Titlu pentru motoarele de cƒÉutare" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :meta_description, "Descriere SEO" %>
            <%= form.text_field :meta_description, placeholder: "Descriere pentru motoarele de cƒÉutare" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :meta_keywords, "Cuvinte cheie" %>
            <%= form.text_field :meta_keywords, placeholder: "cuv√¢nt1, cuv√¢nt2, cuv√¢nt3" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Imagini Produs -->
    <div class="form-section">
      <div class="section-header success">
        üñºÔ∏è Imagini Produs
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <label for="bunny-direct-upload">‚≠ê Imagine principalƒÉ</label>
            <input type="file" id="bunny-direct-upload" accept="image/*" style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" />
            <input type="hidden" name="product[external_image_url]" id="external_image-url" value="<%= @product.external_image_url %>" />
            <div id="main-preview" class="image-preview-container">
              <% if @product.external_image_url.present? %>
                <div class="image-preview-item bunny-preview" data-type="main">
                  <img src="<%= @product.external_image_url %>" style="max-height: 120px;">
                  <button type="button" class="remove-btn remove-bunny-image" data-target="main">√ó</button>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <label for="bunny-secondary-upload">üñºÔ∏è Imagini secundare (galerie)</label>
            <input type="file" id="bunny-secondary-upload" accept="image/*" multiple style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" />
            <div id="bunny-secondary-preview" class="image-preview-container">
              <% if @product.external_image_urls.present? %>
                <% @product.external_image_urls.each_with_index do |url, idx| %>
                  <div class="image-preview-item bunny-preview" data-type="secondary" data-index="<%= idx %>">
                    <img src="<%= url %>" style="width: 100px;">
                    <button type="button" class="remove-btn remove-bunny-image" data-target="secondary" data-index="<%= idx %>">√ó</button>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <div id="external-hidden-inputs">
          <% (@product.external_image_urls || []).each do |url| %>
            <%= hidden_field_tag 'product[external_image_urls][]', url %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Fi»ôiere Ata»ôate -->
    <div class="form-section">
      <div class="section-header info">
        üìé Fi»ôiere Ata»ôate
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <label for="bunny-files-upload">Fi»ôiere ata»ôate (Bunny)</label>
            <input type="file" id="bunny-files-upload" multiple style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" />
            <div id="bunny-files-preview" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
              <% if @product.external_file_urls.present? %>
                <% @product.external_file_urls.each do |url| %>
                  <div class="file-preview-item">
                    <%= link_to File.basename(URI.parse(url).path), url, target: "_blank", rel: "noopener" %>
                    <button type="button" class="remove-btn remove-bunny-file" data-url="<%= url %>">√ó</button>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="external-file-hidden-inputs">
      <% (@product.external_file_urls || []).each do |url| %>
        <%= hidden_field_tag 'product[external_file_urls][]', url %>
      <% end %>
    </div>

    <!-- Categorii -->
    <div class="form-section" data-controller="category-select">
      <div class="section-header warning">
        üè∑Ô∏è Categorii
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :category_ids, "SelecteazƒÉ categoriile" %>
            <div id="category-options" class="category-badges">
              <% Category.all.each do |category| %>
                <% selected = product.category_ids.include?(category.id) %>
                <span class="category-badge <%= selected ? 'active' : 'inactive' %>"
                      data-id="<%= category.id %>"
                      data-category-select-target="badge"
                      data-action="click->category-select#toggle">
                  <%= category.name %>
                </span>
              <% end %>
            </div>

            <div id="category-hidden-inputs" data-category-select-target="hiddenInputsWrapper">
              <input type="hidden" name="product[category_ids][]" value="">
              <% product.category_ids.each do |cat_id| %>
                <input type="hidden" name="product[category_ids][]" value="<%= cat_id %>">
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Atribute Personalizate -->
    <div class="form-section">
      <div class="section-header secondary">
        üíª Atribute Personalizate
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :custom_attributes, "Atribute personalizate (JSON)" %>
            <%= form.text_area :custom_attributes, placeholder: '{"key": "value"}', style: "font-family: monospace;" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug / Test -->
    <div class="form-section">
      <div class="section-header danger">
        üîß Debug / Test
      </div>
      <div class="section-body">
        <button type="button" class="btn btn-danger" onclick="testPresign()">
          TesteazƒÉ presign
        </button>
      </div>
    </div>

    <div class="form-actions">
      <%= link_to "AnuleazƒÉ", products_path, class: "btn btn-secondary" %>
      <%= form.submit "SalveazƒÉ produsul", class: "btn btn-primary" %>
    </div>

  <% end %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const badges = document.querySelectorAll(".category-badge");
  const hiddenInputsWrapper = document.getElementById("category-hidden-inputs");

  function toggleBadge(e) {
    const badge = e.target;
    const id = badge.dataset.id;
    const existingInputs = [...hiddenInputsWrapper.querySelectorAll(`input[value="${id}"]`)];

    if (existingInputs.length > 0) {
      existingInputs.forEach(input => input.remove());
      badge.classList.remove("active");
      badge.classList.add("inactive");
    } else {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "product[category_ids][]";
      input.value = id;
      hiddenInputsWrapper.appendChild(input);
      badge.classList.remove("inactive");
      badge.classList.add("active");
    }
  }

  badges.forEach(badge => {
    badge.removeEventListener("click", toggleBadge);
    badge.addEventListener("click", toggleBadge);
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("form");
  const mainInput = document.getElementById("bunny-direct-upload");
  const mainPreview = document.getElementById("main-preview");
  const mainHidden = document.getElementById("external_image-url");

  const secondaryInput = document.getElementById("bunny-secondary-upload");
  const secondaryPreview = document.getElementById("bunny-secondary-preview");

  const createImageElement = (url, type, index = null) => {
    const div = document.createElement("div");
    div.className = "image-preview-item bunny-preview";
    div.dataset.type = type;
    if (index !== null) div.dataset.index = index;

    const img = document.createElement("img");
    img.src = url;
    if (type === "main") {
      img.style.maxHeight = "120px";
    } else {
      img.style.width = "100px";
    }

    const btn = document.createElement("button");
    btn.className = "remove-btn remove-bunny-image";
    btn.textContent = "√ó";
    btn.type = "button";
    btn.dataset.target = type;
    if (type === "secondary") btn.dataset.index = index;

    div.appendChild(img);
    div.appendChild(btn);
    return div;
  };

  if (mainInput) {
    mainInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const res = await fetch(`/uploads/presign?filename=${encodeURIComponent(file.name)}`);
      const { upload_url, headers } = await res.json();

      const upload = await fetch(upload_url, {
        method: "PUT",
        headers: {
          "Content-Type": headers["Content-Type"],
          "AccessKey": headers["AccessKey"]
        },
        body: file
      });

      if (upload.ok) {
        const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
        const cdnUrl = `https://ayus-cdn.b-cdn.net/${path}`;

        mainHidden.value = cdnUrl;
        mainPreview.innerHTML = "";
        mainPreview.appendChild(createImageElement(cdnUrl, "main"));
      }
    });
  }

  if (secondaryInput) {
    secondaryInput.addEventListener("change", async () => {
      const existingInputs = document.querySelectorAll("input[name='product[external_image_urls][]']");
      let currentIndex = existingInputs.length;

      for (const file of secondaryInput.files) {
        const res = await fetch(`/uploads/presign?filename=${encodeURIComponent(file.name)}`);
        const { upload_url, headers } = await res.json();

        const upload = await fetch(upload_url, {
          method: "PUT",
          headers: {
            "Content-Type": headers["Content-Type"],
            "AccessKey": headers["AccessKey"]
          },
          body: file
        });

        if (upload.ok) {
          const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
          const cdnUrl = `https://ayus-cdn.b-cdn.net/${path}`;

          const existingImgs = secondaryPreview.querySelectorAll("img");
          const alreadyExists = Array.from(existingImgs).some(img => img.src === cdnUrl);
          if (alreadyExists) continue;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "product[external_image_urls][]";
          hidden.value = cdnUrl;
          const externalContainer = document.getElementById("external-hidden-inputs");
          externalContainer.appendChild(hidden);

          secondaryPreview.appendChild(createImageElement(cdnUrl, "secondary", currentIndex));
          currentIndex++;
        }
      }

      secondaryInput.value = "";
    });
  }

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-bunny-image")) {
      const target = e.target.dataset.target;

      if (target === "main") {
        mainHidden.value = "";
        mainPreview.innerHTML = "";
      }

      if (target === "secondary") {
        const container = e.target.closest(".bunny-preview");
        const img = container.querySelector("img");
        const url = img.src;

        const hiddenInputs = document.querySelectorAll("input[name='product[external_image_urls][]']");
        hiddenInputs.forEach(input => {
          if (input.value === url) input.remove();
        });

        container.remove();
      }
    }
  });
});
</script>

<script>
  function testPresign() {
    fetch("/uploads/presign?filename=test_bunny.png")
      .then(response => response.json())
      .then(data => console.log("Presign OK:", data))
      .catch(error => console.error("Eroare:", error));
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const fileInput = document.getElementById("bunny-files-upload");
  const filePreview = document.getElementById("bunny-files-preview");
  const fileHiddenInputs = document.getElementById("external-file-hidden-inputs");

  if (fileInput) {
    fileInput.addEventListener("change", async () => {
      for (const file of fileInput.files) {
        const uniqueFilename = `${Date.now()}_${encodeURIComponent(file.name)}`;

        const res = await fetch(`/uploads/presign?filename=${uniqueFilename}`);
        const { upload_url, headers } = await res.json();

        const upload = await fetch(upload_url, {
          method: "PUT",
          headers: {
            "Content-Type": headers["Content-Type"],
            "AccessKey": headers["AccessKey"]
          },
          body: file
        });

        if (upload.ok) {
          const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
          const cdnUrl = `https://ayus-cdn.b-cdn.net/${path}`;

          const exists = [...fileHiddenInputs.querySelectorAll("input")].some(input => input.value === cdnUrl);
          if (exists) continue;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "product[external_file_urls][]";
          hidden.value = cdnUrl;
          fileHiddenInputs.appendChild(hidden);

          const wrapper = document.createElement("div");
          wrapper.className = "file-preview-item";

          const link = document.createElement("a");
          link.href = cdnUrl;
          link.target = "_blank";
          link.rel = "noopener";
          link.textContent = file.name;

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn remove-bunny-file";
          removeBtn.textContent = "√ó";
          removeBtn.type = "button";
          removeBtn.dataset.url = cdnUrl;

          wrapper.appendChild(link);
          wrapper.appendChild(removeBtn);
          filePreview.appendChild(wrapper);
        }
      }

      fileInput.value = "";
    });
  }

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-bunny-file")) {
      const url = e.target.dataset.url;

      const hiddenInputs = document.querySelectorAll("input[name='product[external_file_urls][]']");
      hiddenInputs.forEach(input => {
        if (input.value === url) input.remove();
      });

      const card = e.target.closest(".file-preview-item");
      if (card) card.remove();
    }
  });
});
</script>
