<div class="form-container">
  <%= form_with(model: product, local: true, html: { multipart: true }) do |form| %>

    <% if product.errors.any? %>
      <div class="alert-danger">
        <h4>‚ö†Ô∏è <%= pluralize(product.errors.count, "error") %> prohibited this product from being saved:</h4>
        <ul>
          <% product.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Informa»õii de bazƒÉ -->
    <div class="form-section">
      <div class="section-header primary">
        üìã Informa»õii de bazƒÉ
      </div>
      <div class="section-body">
        <div class="form-row cols-2">
          <div class="form-field">
            <%= form.label :name, "Nume produs" %>
            <%= form.text_field :name, placeholder: "Nume produs", id: "product_name" %>
          </div>
          <div class="form-field">
            <%= form.label :slug, "URL Slug" %>
            <div style="display:flex; gap:6px; align-items:center;">
              <%= form.text_field :slug, placeholder: "url-friendly-name", id: "product_slug", style: "flex:1;" %>
              <button type="button" id="slug-auto-btn" style="display:none; padding:2px 8px; font-size:12px; cursor:pointer; border:1px solid #ccc; border-radius:4px; background:#f8f9fa;" title="Revenire la auto-generare din nume">&#8635; Auto</button>
            </div>
            <small id="slug-status" style="display:none; margin-top:4px;"></small>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :description_title, "Titlu descriere" %>
            <%= form.text_field :description_title, placeholder: "Titlu pentru sec»õiunea de descriere" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :description, "Descriere" %>
            <%= form.text_area :description, placeholder: "Descriere detaliatƒÉ a produsului..." %>
          </div>
        </div>

        <div class="form-row cols-3">
          <div class="form-field">
            <%= form.label :sku, "SKU" %>
            <div style="display:flex; gap:6px; align-items:center;">
              <%= form.text_field :sku, placeholder: "SKU-12345", id: "product_sku", style: "flex:1;" %>
              <button type="button" id="sku-auto-btn" style="display:none; padding:2px 8px; font-size:12px; cursor:pointer; border:1px solid #ccc; border-radius:4px; background:#f8f9fa;" title="Revenire la auto-generare din nume">&#8635; Auto</button>
            </div>
            <small id="sku-status" style="display:none; margin-top:4px;"></small>
          </div>
          <div class="form-field">
            <%= form.label :status, "Status" %>
            <%= form.select :status, ["active", "inactive", "archived"], {}, {} %>
          </div>
          <div class="checkbox-field" style="margin-top: 24px;">
            <%= form.check_box :featured %>
            <%= form.label :featured, "Produs promovat" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Pre»õuri »ôi Taxe -->
    <div class="form-section" id="section-prices">
      <div class="section-header success">
        üí∞ Pre»õuri »ôi Taxe
      </div>
      <div class="section-body">
        <div class="form-row cols-4">
          <div class="form-field">
            <%= form.label :price, "Pre»õ v√¢nzare" %>
            <div class="input-group">
              <%= form.number_field :price, step: 0.01, placeholder: "0.00" %>
              <span class="input-group-text">RON</span>
            </div>
            <small class="form-hint">Pre»õul afi»ôat clientului (obligatoriu)</small>
          </div>
          <div class="form-field">
            <%= form.label :cost_price, "Pre»õ achizi»õie" %>
            <div class="input-group">
              <%= form.number_field :cost_price, step: 0.01, placeholder: "0.00" %>
              <span class="input-group-text">RON</span>
            </div>
            <small class="form-hint">C√¢t ai plƒÉtit pe produs (vizibil doar admin, pentru calcul profit)</small>
          </div>
          <div class="form-field">
            <%= form.label :discount_price, "Pre»õ promo»õional" %>
            <div class="input-group">
              <%= form.number_field :discount_price, step: 0.01, placeholder: "0.00" %>
              <span class="input-group-text">RON</span>
            </div>
            <label style="display:flex; align-items:center; gap:6px; margin-top:6px; cursor:pointer;">
              <%= form.check_box :promo_active, style: "width:auto; margin:0;" %>
              <span style="font-size:13px; font-weight:600;">Afi»ôeazƒÉ pre»õul promo»õional √Æn site</span>
            </label>
            <small class="form-hint">BifeazƒÉ pentru a arƒÉta clientului pre»õul tƒÉiat + pre»õul redus</small>
          </div>
          <div class="form-field">
            <%= form.label :vat, "TVA" %>
            <div class="input-group">
              <%= form.number_field :vat, min: 0, placeholder: "19" %>
              <span class="input-group-text">%</span>
            </div>
            <small class="form-hint">Cota TVA inclusƒÉ √Æn pre»õ (standard: 19%)</small>
          </div>
        </div>

        <div class="form-row cols-2">
          <div class="checkbox-field">
            <%= form.check_box :taxable %>
            <%= form.label :taxable, "Se aplicƒÉ TVA" %>
          </div>
          <div class="checkbox-field">
            <%= form.check_box :coupon_applicable %>
            <%= form.label :coupon_applicable, "Se aplicƒÉ cupon de reducere" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventar »ôi Stoc -->
    <div class="form-section" id="section-inventory">
      <div class="section-header info">
        üì¶ Inventar »ôi Stoc
      </div>
      <div class="section-body">
        <div class="form-row cols-3">
          <div class="form-field">
            <%= form.label :stock, "Stoc" %>
            <%= form.number_field :stock, placeholder: "0" %>
          </div>
          <div class="form-field">
            <%= form.label :stock_status, "Status stoc" %>
            <%= form.select :stock_status, Product.stock_statuses.keys.map { |k| [k.humanize, k] } %>
          </div>
          <div class="checkbox-field" style="margin-top: 24px;">
            <%= form.check_box :track_inventory %>
            <%= form.label :track_inventory, "UrmƒÉre»ôte inventarul" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="checkbox-field">
            <%= form.check_box :sold_individually %>
            <%= form.label :sold_individually, "Se vinde individual" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Dimensiuni »ôi Greutate -->
    <div class="form-section">
      <div class="section-header warning">
        üìè Dimensiuni »ôi Greutate
      </div>
      <div class="section-body">
        <div class="form-row cols-4">
          <div class="form-field">
            <%= form.label :height, "√énƒÉl»õime" %>
            <div class="input-group">
              <%= form.number_field :height, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :width, "LƒÉ»õime" %>
            <div class="input-group">
              <%= form.number_field :width, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :depth, "Ad√¢ncime" %>
            <div class="input-group">
              <%= form.number_field :depth, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">mm</span>
            </div>
          </div>
          <div class="form-field">
            <%= form.label :weight, "Greutate" %>
            <div class="input-group">
              <%= form.number_field :weight, step: 1, min: 0, placeholder: "0" %>
              <span class="input-group-text">g</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Disponibilitate -->
    <div class="form-section">
      <div class="section-header secondary">
        üìÖ Disponibilitate
      </div>
      <div class="section-body">
        <div class="form-row cols-2">
          <div class="form-field">
            <%= form.label :available_on, "Disponibil din" %>
            <%= form.date_field :available_on %>
          </div>
          <div class="form-field">
            <%= form.label :discontinue_on, "Se √Æntrerupe la" %>
            <%= form.date_field :discontinue_on %>
          </div>
        </div>
      </div>
    </div>

    <!-- ConfigurƒÉri Produs -->
    <div class="form-section">
      <div class="section-header dark">
        ‚öôÔ∏è ConfigurƒÉri Produs
      </div>
      <div class="section-body">
        <div class="form-row cols-2">
          <div class="form-field">
            <%= form.label :product_type, "Tip produs" %>
            <%= form.select :product_type, Product.product_types.keys.map { |t| [t.titleize, t] } %>
          </div>
          <div class="form-field">
            <%= form.label :delivery_method, "Mod de livrare" %>
            <%= form.select :delivery_method, Product.delivery_methods.keys.map { |k| [k.titleize, k] } %>
          </div>
        </div>

        <div class="form-row cols-2">
          <div class="checkbox-field">
            <%= form.check_box :requires_login %>
            <%= form.label :requires_login, "Doar utilizatori loga»õi pot cumpƒÉra" %>
          </div>
          <div class="checkbox-field">
            <%= form.check_box :visible_to_guests %>
            <%= form.label :visible_to_guests, "Vizibil pentru utilizatori neautentifica»õi" %>
          </div>
        </div>
      </div>
    </div>

    <!-- SEO »ôi Metadata -->
    <div class="form-section">
      <div class="section-header primary">
        üîç SEO »ôi Metadata
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :meta_title, "Titlu SEO" %>
            <%= form.text_field :meta_title, placeholder: "Titlu pentru motoarele de cƒÉutare" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :meta_description, "Descriere SEO" %>
            <%= form.text_field :meta_description, placeholder: "Descriere pentru motoarele de cƒÉutare" %>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :meta_keywords, "Cuvinte cheie" %>
            <%= form.text_field :meta_keywords, placeholder: "cuv√¢nt1, cuv√¢nt2, cuv√¢nt3" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Imagini Produs -->
    <div class="form-section">
      <div class="section-header success">
        üñºÔ∏è Imagini Produs
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <label for="bunny-direct-upload">‚≠ê Imagine principalƒÉ</label>
            <input type="file" id="bunny-direct-upload" accept="image/*" style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" />
            <input type="hidden" name="product[external_image_url]" id="external_image-url" value="<%= @product.external_image_url %>" />
            <div id="main-preview" class="image-preview-container">
              <% if @product.external_image_url.present? %>
                <div class="image-preview-item bunny-preview" data-type="main">
                  <img src="<%= @product.external_image_url %>" style="max-height: 120px;">
                  <button type="button" class="remove-btn remove-bunny-image" data-target="main">√ó</button>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <div class="form-row cols-1">
          <div class="form-field">
            <label for="bunny-secondary-upload">üñºÔ∏è Imagini secundare (galerie)</label>
            <input type="file" id="bunny-secondary-upload" accept="image/*" multiple style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" />
            <div id="bunny-secondary-preview" class="image-preview-container">
              <% if @product.external_image_urls.present? %>
                <% @product.external_image_urls.each_with_index do |url, idx| %>
                  <div class="image-preview-item bunny-preview" data-type="secondary" data-index="<%= idx %>">
                    <img src="<%= url %>" style="width: 100px;">
                    <button type="button" class="remove-btn remove-bunny-image" data-target="secondary" data-index="<%= idx %>">√ó</button>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <div id="external-hidden-inputs">
          <% (@product.external_image_urls || []).each do |url| %>
            <%= hidden_field_tag 'product[external_image_urls][]', url %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Fi»ôiere Ata»ôate -->
    <div class="form-section">
      <div class="section-header info">
        üìé Fi»ôiere Ata»ôate
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <label for="bunny-files-upload">Fi»ôiere ata»ôate (Bunny)</label>
            <input type="file" id="bunny-files-upload" multiple style="padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px;" />
            <div id="bunny-files-preview" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
              <% if @product.external_file_urls.present? %>
                <% @product.external_file_urls.each do |url| %>
                  <div class="file-preview-item">
                    <%= link_to File.basename(URI.parse(url).path), url, target: "_blank", rel: "noopener" %>
                    <button type="button" class="remove-btn remove-bunny-file" data-url="<%= url %>">√ó</button>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="external-file-hidden-inputs">
      <% (@product.external_file_urls || []).each do |url| %>
        <%= hidden_field_tag 'product[external_file_urls][]', url %>
      <% end %>
    </div>

    <!-- Categorii -->
    <div class="form-section">
      <div class="section-header warning">
        üè∑Ô∏è Categorii
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :category_ids, "SelecteazƒÉ categoriile" %>
            <div id="category-options" class="category-badges">
              <% Category.all.each do |category| %>
                <% selected = product.category_ids.include?(category.id) %>
                <span class="category-badge <%= selected ? 'active' : 'inactive' %>"
                      data-id="<%= category.id %>">
                  <%= category.name %>
                </span>
              <% end %>
            </div>

            <div id="category-hidden-inputs">
              <input type="hidden" name="product[category_ids][]" value="">
              <% product.category_ids.each do |cat_id| %>
                <input type="hidden" name="product[category_ids][]" value="<%= cat_id %>">
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Variante Produs -->
    <div class="form-section" id="section-variants-toggle">
      <div class="section-header dark">
        Variante Produs
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="checkbox-field">
            <% has_variants = form.object.variants.any? { |v| !v.marked_for_destruction? } %>
            <%= hidden_field_tag :has_variants, '0', id: nil %>
            <%= check_box_tag :has_variants, '1', has_variants, id: 'toggle-has-variants', data: { action: 'change' } %>
            <label for="toggle-has-variants">Are variante? (culoare, marime, etc.)</label>
          </div>
        </div>
        <% if has_variants %>
          <p class="variant-warning">Pretul si stocul se gestioneaza la nivel de varianta.</p>
        <% end %>
      </div>
    </div>

    <div class="form-section" id="section-primary-option" style="<%= has_variants ? '' : 'display:none;' %>">
      <div class="section-header dark">
        Op»õiune PrincipalƒÉ (swatches pe site)
      </div>
      <div class="section-body">
        <p class="variant-warning">SelecteazƒÉ op»õiunea care va fi afi»ôatƒÉ ca imagini thumbnail pe pagina produsului. Obligatorie.</p>
        <div class="form-row cols-1" id="primary-option-radios">
          <% current_primary_id = form.object.primary_product_option_type&.option_type_id %>
          <% (@option_types || []).each do |ot| %>
            <div class="radio-field">
              <%= radio_button_tag :primary_option_type_id, ot.id,
                  current_primary_id == ot.id,
                  id: "primary_option_type_#{ot.id}" %>
              <label for="primary_option_type_<%= ot.id %>"><%= ot.presentation || ot.name %></label>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="form-section" id="section-variants" style="<%= has_variants ? '' : 'display:none;' %>">
      <div class="section-header dark">
        Lista Variante
      </div>
      <div class="section-body">
        <table class="variants-table" id="variants-table">
          <thead>
            <tr>
              <th>Optiuni</th>
              <th colspan="5">SKU</th>
            </tr>
            <tr>
              <th>Imagine</th>
              <th>Pret vanzare</th>
              <th>Achizitie</th>
              <th>Promo</th>
              <th>Stoc</th>
              <th>TVA %</th>
              <th>Status</th>
              <th>Sursa</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="variants-tbody">
            <% variants_list = if form.object.errors.any? || !form.object.persisted?
                 form.object.variants.reject(&:marked_for_destruction?).to_a
               else
                 respond_to?(:preload_variants) ? preload_variants(form.object) : form.object.variants.order(:id).to_a
               end %>
            <% variants_list.each do |variant| %>
              <%= form.fields_for :variants, variant do |vf| %>
                <%= render 'variant_fields', f: vf, variant: variant, option_types: (@option_types || []) %>
              <% end %>
            <% end %>
          </tbody>
        </table>

        <button type="button" class="btn btn-info" id="btn-add-variant"
                data-option-types="<%= (@option_types || []).map { |ot| { id: ot.id, name: ot.name, values: ot.option_values.map { |ov| { id: ov.id, name: ov.display_name } } } }.to_json %>"
                data-variant-index="<%= variants_list.size %>">
          + Adauga varianta
        </button>
      </div>
    </div>

    <!-- Atribute Personalizate -->
    <div class="form-section">
      <div class="section-header secondary">
        üíª Atribute Personalizate
      </div>
      <div class="section-body">
        <div class="form-row cols-1">
          <div class="form-field">
            <%= form.label :custom_attributes, "Atribute personalizate (JSON)" %>
            <%= form.text_area :custom_attributes, placeholder: '{"key": "value"}', style: "font-family: monospace;" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug / Test -->
    <div class="form-section">
      <div class="section-header danger">
        üîß Debug / Test
      </div>
      <div class="section-body">
        <button type="button" class="btn btn-danger" onclick="testPresign()">
          TesteazƒÉ presign
        </button>
      </div>
    </div>

    <div class="form-actions">
      <%= link_to "AnuleazƒÉ", products_path, class: "btn btn-secondary" %>
      <%= form.submit "SalveazƒÉ produsul", class: "btn btn-primary" %>
    </div>

  <% end %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const badges = document.querySelectorAll(".category-badge");
  const hiddenInputsWrapper = document.getElementById("category-hidden-inputs");

  function toggleBadge(e) {
    const badge = e.target;
    const id = badge.dataset.id;
    const existingInputs = [...hiddenInputsWrapper.querySelectorAll(`input[value="${id}"]`)];

    if (existingInputs.length > 0) {
      existingInputs.forEach(input => input.remove());
      badge.classList.remove("active");
      badge.classList.add("inactive");
    } else {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "product[category_ids][]";
      input.value = id;
      hiddenInputsWrapper.appendChild(input);
      badge.classList.remove("inactive");
      badge.classList.add("active");
    }
  }

  badges.forEach(badge => {
    badge.removeEventListener("click", toggleBadge);
    badge.addEventListener("click", toggleBadge);
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("form");
  const mainInput = document.getElementById("bunny-direct-upload");
  const mainPreview = document.getElementById("main-preview");
  const mainHidden = document.getElementById("external_image-url");

  const secondaryInput = document.getElementById("bunny-secondary-upload");
  const secondaryPreview = document.getElementById("bunny-secondary-preview");

  const createImageElement = (url, type, index = null) => {
    const div = document.createElement("div");
    div.className = "image-preview-item bunny-preview";
    div.dataset.type = type;
    if (index !== null) div.dataset.index = index;

    const img = document.createElement("img");
    img.src = url;
    if (type === "main") {
      img.style.maxHeight = "120px";
    } else {
      img.style.width = "100px";
    }

    const btn = document.createElement("button");
    btn.className = "remove-btn remove-bunny-image";
    btn.textContent = "√ó";
    btn.type = "button";
    btn.dataset.target = type;
    if (type === "secondary") btn.dataset.index = index;

    div.appendChild(img);
    div.appendChild(btn);
    return div;
  };

  if (mainInput) {
    mainInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const res = await fetch(`/uploads/presign?filename=${encodeURIComponent(file.name)}`);
      const { upload_url, headers } = await res.json();

      const upload = await fetch(upload_url, {
        method: "PUT",
        headers: {
          "Content-Type": headers["Content-Type"],
          "AccessKey": headers["AccessKey"]
        },
        body: file
      });

      if (upload.ok) {
        const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
        const cdnUrl = `https://ayus-cdn.b-cdn.net/${path}`;

        mainHidden.value = cdnUrl;
        mainPreview.innerHTML = "";
        mainPreview.appendChild(createImageElement(cdnUrl, "main"));
      }
    });
  }

  if (secondaryInput) {
    secondaryInput.addEventListener("change", async () => {
      const existingInputs = document.querySelectorAll("input[name='product[external_image_urls][]']");
      let currentIndex = existingInputs.length;

      for (const file of secondaryInput.files) {
        const res = await fetch(`/uploads/presign?filename=${encodeURIComponent(file.name)}`);
        const { upload_url, headers } = await res.json();

        const upload = await fetch(upload_url, {
          method: "PUT",
          headers: {
            "Content-Type": headers["Content-Type"],
            "AccessKey": headers["AccessKey"]
          },
          body: file
        });

        if (upload.ok) {
          const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
          const cdnUrl = `https://ayus-cdn.b-cdn.net/${path}`;

          const existingImgs = secondaryPreview.querySelectorAll("img");
          const alreadyExists = Array.from(existingImgs).some(img => img.src === cdnUrl);
          if (alreadyExists) continue;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "product[external_image_urls][]";
          hidden.value = cdnUrl;
          const externalContainer = document.getElementById("external-hidden-inputs");
          externalContainer.appendChild(hidden);

          secondaryPreview.appendChild(createImageElement(cdnUrl, "secondary", currentIndex));
          currentIndex++;
        }
      }

      secondaryInput.value = "";
    });
  }

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-bunny-image")) {
      const target = e.target.dataset.target;

      if (target === "main") {
        mainHidden.value = "";
        mainPreview.innerHTML = "";
      }

      if (target === "secondary") {
        const container = e.target.closest(".bunny-preview");
        const img = container.querySelector("img");
        const url = img.src;

        const hiddenInputs = document.querySelectorAll("input[name='product[external_image_urls][]']");
        hiddenInputs.forEach(input => {
          if (input.value === url) input.remove();
        });

        container.remove();
      }
    }
  });
});
</script>

<script>
  function testPresign() {
    fetch("/uploads/presign?filename=test_bunny.png")
      .then(response => response.json())
      .then(data => console.log("Presign OK:", data))
      .catch(error => console.error("Eroare:", error));
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== VARIANTE: Toggle + Add + Remove =====
  const toggleCheckbox = document.getElementById('toggle-has-variants');
  const sectionVariants = document.getElementById('section-variants');
  const sectionPrices = document.getElementById('section-prices');
  const sectionInventory = document.getElementById('section-inventory');
  const variantWarning = document.querySelector('.variant-warning');
  const addBtn = document.getElementById('btn-add-variant');
  const tbody = document.getElementById('variants-tbody');

  const sectionPrimaryOption = document.getElementById('section-primary-option');

  function updateVariantSections() {
    const on = toggleCheckbox && toggleCheckbox.checked;
    if (sectionVariants) sectionVariants.style.display = on ? '' : 'none';
    if (sectionPrimaryOption) sectionPrimaryOption.style.display = on ? '' : 'none';
    if (sectionPrices) sectionPrices.style.display = on ? 'none' : '';
    if (sectionInventory) sectionInventory.style.display = on ? 'none' : '';
    if (variantWarning) variantWarning.style.display = on ? '' : 'none';
  }

  if (toggleCheckbox) {
    toggleCheckbox.addEventListener('change', updateVariantSections);
    updateVariantSections();
  }

  // Add new variant row
  if (addBtn && tbody) {
    addBtn.addEventListener('click', function() {
      const idx = Date.now();
      const prefix = `product[variants_attributes][${idx}]`;
      const optionTypes = JSON.parse(addBtn.dataset.optionTypes || '[]');
      const statuses = ['active', 'inactive'];

      let optionsHtml = '';
      optionTypes.forEach(function(ot) {
        let opts = '<option value="">-- alege --</option>';
        (ot.values || []).forEach(function(ov) {
          opts += `<option value="${ov.id}">${ov.name}</option>`;
        });
        optionsHtml += `<div class="variant-option-select">
          <label class="variant-option-label">${ot.name}</label>
          <select name="${prefix}[option_value_ids][]" class="variant-input">${opts}</select>
        </div>`;
      });

      let statusOpts = '';
      statuses.forEach(function(s) {
        statusOpts += `<option value="${s}">${s.charAt(0).toUpperCase() + s.slice(1)}</option>`;
      });

      // Rand 1: Optiuni + SKU
      const tr1 = document.createElement('tr');
      tr1.className = 'variant-row variant-row-top variant-new';
      tr1.innerHTML = `
        <input type="hidden" name="${prefix}[_destroy]" value="0" class="destroy-flag">
        <td class="variant-options-cell">${optionsHtml}</td>
        <td colspan="5">
          <label class="variant-field-label">SKU</label>
          <div style="display:flex; gap:4px; align-items:center;">
            <input type="text" name="${prefix}[sku]" placeholder="SKU-001" class="variant-input variant-sku" style="flex:1;" data-variant-id="">
            <button type="button" class="variant-sku-auto-btn" style="display:none; padding:1px 6px; font-size:11px; cursor:pointer; border:1px solid #ccc; border-radius:3px; background:#f8f9fa; white-space:nowrap;" title="Revenire la auto-generare">&#8635;</button>
          </div>
          <small class="variant-sku-status" style="display:none; margin-top:2px; font-size:11px;"></small>
        </td>
      `;

      // Rand 2: Imagine + Pret + Stoc + TVA + Status + Sursa + X
      const tr2 = document.createElement('tr');
      tr2.className = 'variant-row variant-row-bottom variant-new';
      tr2.innerHTML = `
        <td class="variant-image-cell">
          <label class="variant-field-label">Imagine</label>
          <input type="hidden" name="${prefix}[external_image_url]" value="" class="variant-image-hidden">
          <div class="variant-images-hidden"></div>
          <div class="variant-image-gallery"></div>
          <input type="file" accept="image/*" multiple class="variant-image-input" />
          <label class="variant-add-img-btn" title="Adauga imagini">+</label>
        </td>
        <td><label class="variant-field-label">Pret vanzare</label><input type="number" name="${prefix}[price]" step="0.01" min="0" placeholder="0.00" class="variant-input variant-price"></td>
        <td><label class="variant-field-label">Pret achizitie</label><input type="number" name="${prefix}[cost_price]" step="0.01" min="0" placeholder="0.00" class="variant-input variant-cost-price" style="width:70px;"></td>
        <td><label class="variant-field-label">Promo (RON)</label><input type="number" name="${prefix}[discount_price]" step="0.01" min="0" placeholder="0.00" class="variant-input variant-discount-price" style="width:70px;"><label style="display:flex;align-items:center;gap:3px;margin-top:3px;cursor:pointer;"><input type="hidden" name="${prefix}[promo_active]" value="0"><input type="checkbox" name="${prefix}[promo_active]" value="1" style="width:auto;margin:0;"><span style="font-size:10px;">Activ</span></label></td>
        <td><label class="variant-field-label">Stoc</label><input type="number" name="${prefix}[stock]" min="0" placeholder="0" class="variant-input variant-stock"></td>
        <td><label class="variant-field-label">TVA %</label><input type="number" name="${prefix}[vat_rate]" min="0" step="0.01" placeholder="0" value="0" class="variant-input variant-vat"></td>
        <td><label class="variant-field-label">Status</label><select name="${prefix}[status]" class="variant-input variant-status">${statusOpts}</select></td>
        <td><label class="variant-field-label">Sursa</label><br><span class="badge badge-new">Nou</span></td>
        <td><button type="button" class="btn btn-danger btn-sm btn-remove-variant" title="Sterge varianta">&times;</button></td>
      `;

      tbody.appendChild(tr1);
      tbody.appendChild(tr2);
    });
  }

  // Remove variant (delegate) - handles both rows (top + bottom)
  // Button X is in bottom row, so find top row via previousElementSibling
  document.addEventListener('click', function(e) {
    if (!e.target.classList.contains('btn-remove-variant')) return;
    const bottomRow = e.target.closest('tr.variant-row-bottom');
    var topRow;
    if (bottomRow) {
      topRow = bottomRow.previousElementSibling;
    } else {
      // fallback: button might be in top row
      topRow = e.target.closest('tr.variant-row-top');
    }
    if (!topRow) return;
    const realBottom = bottomRow || topRow.nextElementSibling;

    const idField = topRow.querySelector('input[name$="[id]"]');
    const destroyFlag = topRow.querySelector('.destroy-flag');
    if (idField && idField.value) {
      // Existing persisted variant ‚Äî mark for destruction, hide both rows
      destroyFlag.value = '1';
      topRow.classList.add('variant-destroyed');
      topRow.style.display = 'none';
      if (realBottom && realBottom.classList.contains('variant-row-bottom')) {
        realBottom.classList.add('variant-destroyed');
        realBottom.style.display = 'none';
      }
    } else {
      // New unsaved variant ‚Äî remove both rows from DOM
      if (realBottom && realBottom.classList.contains('variant-row-bottom')) {
        realBottom.remove();
      }
      topRow.remove();
    }
  });

  // ===== VARIANTE: Buton "+" deschide file input ascuns =====
  document.addEventListener('click', function(e) {
    if (!e.target.classList.contains('variant-add-img-btn')) return;
    const td = e.target.closest('.variant-image-cell');
    const fileInput = td.querySelector('.variant-image-input');
    if (fileInput) fileInput.click();
  });

  // ===== VARIANTE: Upload imagini pe Bunny CDN (multiplu) =====
  document.addEventListener('change', async function(e) {
    if (!e.target.classList.contains('variant-image-input')) return;
    const files = e.target.files;
    if (!files.length) return;
    const td = e.target.closest('.variant-image-cell');
    const mainHidden = td.querySelector('.variant-image-hidden');
    const gallery = td.querySelector('.variant-image-gallery');
    const hiddenContainer = td.querySelector('.variant-images-hidden');
    // Determina prefix-ul name-ului din hidden field-ul principal
    const mainName = mainHidden.name; // ex: product[variants_attributes][123][external_image_url]
    const baseName = mainName.replace('[external_image_url]', '[external_image_urls][]');

    for (const file of files) {
      const uniqueName = Date.now() + '_' + encodeURIComponent(file.name);
      const res = await fetch('/uploads/presign?filename=' + uniqueName);
      const { upload_url, headers } = await res.json();

      const upload = await fetch(upload_url, {
        method: 'PUT',
        headers: { 'Content-Type': headers['Content-Type'], 'AccessKey': headers['AccessKey'] },
        body: file
      });

      if (upload.ok) {
        const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
        const cdnUrl = 'https://ayus-cdn.b-cdn.net/' + path;

        // Prima imagine devine principala daca nu exista inca
        if (!mainHidden.value) {
          mainHidden.value = cdnUrl;
          const item = document.createElement('div');
          item.className = 'variant-gallery-item';
          item.dataset.role = 'main';
          item.innerHTML = '<img src="' + cdnUrl + '" class="variant-thumb">'
            + '<button type="button" class="remove-btn remove-variant-img" data-role="main">\u00d7</button>'
            + '<span class="variant-img-label">P</span>';
          gallery.appendChild(item);
        } else {
          // Imagine secundara
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = baseName;
          hidden.value = cdnUrl;
          hiddenContainer.appendChild(hidden);

          const item = document.createElement('div');
          item.className = 'variant-gallery-item';
          item.dataset.role = 'secondary';
          item.dataset.url = cdnUrl;
          item.innerHTML = '<img src="' + cdnUrl + '" class="variant-thumb">'
            + '<button type="button" class="remove-btn remove-variant-img" data-role="secondary">\u00d7</button>';
          gallery.appendChild(item);
        }
      }
    }
    e.target.value = '';
  });

  // Remove variant image (principala sau secundara)
  document.addEventListener('click', function(e) {
    if (!e.target.classList.contains('remove-variant-img')) return;
    const item = e.target.closest('.variant-gallery-item');
    const td = e.target.closest('.variant-image-cell');
    const role = e.target.dataset.role;

    if (role === 'main') {
      // Sterge imaginea principala
      td.querySelector('.variant-image-hidden').value = '';
      item.remove();
      // Promoveaza prima secundara ca principala (daca exista)
      const firstSecondary = td.querySelector('.variant-gallery-item[data-role="secondary"]');
      if (firstSecondary) {
        const url = firstSecondary.dataset.url;
        td.querySelector('.variant-image-hidden').value = url;
        firstSecondary.dataset.role = 'main';
        firstSecondary.querySelector('.remove-variant-img').dataset.role = 'main';
        firstSecondary.innerHTML = '<img src="' + url + '" class="variant-thumb">'
          + '<button type="button" class="remove-btn remove-variant-img" data-role="main">\u00d7</button>'
          + '<span class="variant-img-label">P</span>';
        // Sterge hidden input-ul secundar pentru URL-ul promovat
        const hiddenContainer = td.querySelector('.variant-images-hidden');
        const hiddens = hiddenContainer.querySelectorAll('input[type="hidden"]');
        hiddens.forEach(function(h) { if (h.value === url) h.remove(); });
      }
    } else {
      // Sterge imaginea secundara
      const url = item.dataset.url;
      const hiddenContainer = td.querySelector('.variant-images-hidden');
      const hiddens = hiddenContainer.querySelectorAll('input[type="hidden"]');
      hiddens.forEach(function(h) { if (h.value === url) h.remove(); });
      item.remove();
    }
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const fileInput = document.getElementById("bunny-files-upload");
  const filePreview = document.getElementById("bunny-files-preview");
  const fileHiddenInputs = document.getElementById("external-file-hidden-inputs");

  if (fileInput) {
    fileInput.addEventListener("change", async () => {
      for (const file of fileInput.files) {
        const uniqueFilename = `${Date.now()}_${encodeURIComponent(file.name)}`;

        const res = await fetch(`/uploads/presign?filename=${uniqueFilename}`);
        const { upload_url, headers } = await res.json();

        const upload = await fetch(upload_url, {
          method: "PUT",
          headers: {
            "Content-Type": headers["Content-Type"],
            "AccessKey": headers["AccessKey"]
          },
          body: file
        });

        if (upload.ok) {
          const path = new URL(upload_url).pathname.split('/').slice(2).join('/');
          const cdnUrl = `https://ayus-cdn.b-cdn.net/${path}`;

          const exists = [...fileHiddenInputs.querySelectorAll("input")].some(input => input.value === cdnUrl);
          if (exists) continue;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.name = "product[external_file_urls][]";
          hidden.value = cdnUrl;
          fileHiddenInputs.appendChild(hidden);

          const wrapper = document.createElement("div");
          wrapper.className = "file-preview-item";

          const link = document.createElement("a");
          link.href = cdnUrl;
          link.target = "_blank";
          link.rel = "noopener";
          link.textContent = file.name;

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn remove-bunny-file";
          removeBtn.textContent = "√ó";
          removeBtn.type = "button";
          removeBtn.dataset.url = cdnUrl;

          wrapper.appendChild(link);
          wrapper.appendChild(removeBtn);
          filePreview.appendChild(wrapper);
        }
      }

      fileInput.value = "";
    });
  }

  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-bunny-file")) {
      const url = e.target.dataset.url;

      const hiddenInputs = document.querySelectorAll("input[name='product[external_file_urls][]']");
      hiddenInputs.forEach(input => {
        if (input.value === url) input.remove();
      });

      const card = e.target.closest(".file-preview-item");
      if (card) card.remove();
    }
  });
});
</script>

<script>
// ===== AUTO-GENERARE LIVE: Slug + SKU Produs + SKU Variante =====
document.addEventListener("DOMContentLoaded", function() {
  var nameField = document.getElementById('product_name');
  var slugField = document.getElementById('product_slug');
  var skuField = document.getElementById('product_sku');
  var slugStatus = document.getElementById('slug-status');
  var skuStatus = document.getElementById('sku-status');
  var slugAutoBtn = document.getElementById('slug-auto-btn');
  var skuAutoBtn = document.getElementById('sku-auto-btn');

  if (!nameField || !slugField || !skuField) return;

  var isNewProduct = !slugField.value.trim();
  var slugManuallyEdited = false;
  var skuManuallyEdited = false;
  var slugCheckTimer = null;
  var skuCheckTimer = null;
  var productId = '<%= product.persisted? ? product.id : "" %>';

  function parameterize(str) {
    return str.toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '');
  }

  // === Auto-generare Slug + SKU din Nume ===
  nameField.addEventListener('input', function() {
    var val = this.value.trim();
    if (!val) return;

    if (isNewProduct && !slugManuallyEdited) {
      slugField.value = parameterize(val);
      clearTimeout(slugCheckTimer);
      slugCheckTimer = setTimeout(function() { checkSlugUniqueness(); }, 600);
    }

    if (isNewProduct && !skuManuallyEdited) {
      skuField.value = parameterize(val).toUpperCase();
      clearTimeout(skuCheckTimer);
      skuCheckTimer = setTimeout(function() { checkSkuUniqueness(); }, 600);
    }
  });

  // === Tracking editare manuala ===
  slugField.addEventListener('input', function() {
    slugManuallyEdited = true;
    if (slugAutoBtn) slugAutoBtn.style.display = 'inline-block';
    clearTimeout(slugCheckTimer);
    slugCheckTimer = setTimeout(function() { checkSlugUniqueness(); }, 600);
  });

  skuField.addEventListener('input', function() {
    skuManuallyEdited = true;
    if (skuAutoBtn) skuAutoBtn.style.display = 'inline-block';
    clearTimeout(skuCheckTimer);
    skuCheckTimer = setTimeout(function() { checkSkuUniqueness(); }, 600);
  });

  // === Butoane reset Auto ===
  if (slugAutoBtn) {
    slugAutoBtn.addEventListener('click', function() {
      slugManuallyEdited = false;
      this.style.display = 'none';
      var val = nameField.value.trim();
      if (val) {
        slugField.value = parameterize(val);
        checkSlugUniqueness();
      }
    });
  }

  if (skuAutoBtn) {
    skuAutoBtn.addEventListener('click', function() {
      skuManuallyEdited = false;
      this.style.display = 'none';
      var val = nameField.value.trim();
      if (val) {
        skuField.value = parameterize(val).toUpperCase();
        checkSkuUniqueness();
      }
    });
  }

  slugField.addEventListener('blur', function() {
    if (this.value.trim()) checkSlugUniqueness();
  });

  skuField.addEventListener('blur', function() {
    if (this.value.trim()) checkSkuUniqueness();
  });

  // === Verificare unicitate slug via AJAX ===
  function checkSlugUniqueness() {
    var slug = slugField.value.trim();
    if (!slug) { slugStatus.style.display = 'none'; return; }

    var url = '/products/check_slug?slug=' + encodeURIComponent(slug);
    if (productId) url += '&product_id=' + productId;

    fetch(url)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        slugStatus.style.display = 'block';
        if (data.available) {
          slugStatus.style.color = '#28a745';
          slugStatus.textContent = '\u2713 URL disponibil';
        } else {
          slugField.value = data.slug;
          slugStatus.style.color = '#dc8a00';
          slugStatus.textContent = '\u26A0 URL ocupat, sugerat: ' + data.slug;
        }
      })
      .catch(function() { slugStatus.style.display = 'none'; });
  }

  // === Verificare unicitate SKU via AJAX ===
  function checkSkuUniqueness() {
    var sku = skuField.value.trim();
    if (!sku) { skuStatus.style.display = 'none'; return; }

    var url = '/products/check_sku?sku=' + encodeURIComponent(sku);
    if (productId) url += '&product_id=' + productId;

    fetch(url)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        skuStatus.style.display = 'block';
        if (data.available) {
          skuStatus.style.color = '#28a745';
          skuStatus.textContent = '\u2713 SKU disponibil';
        } else {
          skuField.value = data.sku;
          skuStatus.style.color = '#dc8a00';
          skuStatus.textContent = '\u26A0 SKU ocupat, sugerat: ' + data.sku;
        }
      })
      .catch(function() { skuStatus.style.display = 'none'; });
  }

  // ===== AUTO-GENERARE SKU VARIANTE =====
  var variantSkuManualEdits = {};

  // Gaseste perechea top/bottom pentru o varianta
  function getVariantPair(anyRow) {
    var topRow, bottomRow;
    if (anyRow.classList.contains('variant-row-top')) {
      topRow = anyRow;
      bottomRow = anyRow.nextElementSibling;
    } else if (anyRow.classList.contains('variant-row-bottom')) {
      bottomRow = anyRow;
      topRow = anyRow.previousElementSibling;
    }
    return { top: topRow, bottom: bottomRow };
  }

  function autoGenerateVariantSku(topRow) {
    var pair = getVariantPair(topRow);
    if (!pair.top) return;

    // SKU input is now in topRow (same row as options)
    var skuInput = pair.top.querySelector('input[name*="[sku]"]');
    if (!skuInput) return;

    var rowId = skuInput.name;
    if (variantSkuManualEdits[rowId]) return;

    // Use product name (parameterized) as base for variant SKU
    var productName = nameField.value.trim();
    var baseSku = productName ? parameterize(productName).toUpperCase() : (skuField.value.trim() || 'VAR');
    var selects = pair.top.querySelectorAll('select[name*="option_value_ids"]');
    var parts = [baseSku];

    selects.forEach(function(sel) {
      var selectedOption = sel.options[sel.selectedIndex];
      var text = selectedOption ? selectedOption.text.trim() : '';
      if (text && text !== '-- alege --') {
        var abbr = parameterize(text).substring(0, 3).toUpperCase();
        if (abbr) parts.push(abbr);
      }
    });

    if (parts.length === 1) {
      var allTopRows = document.querySelectorAll('tr.variant-row-top:not(.variant-destroyed)');
      var idx = Array.from(allTopRows).indexOf(pair.top) + 1;
      parts.push('V' + idx);
    }

    skuInput.value = parts.join('-');
    // Check uniqueness after auto-generation
    checkVariantSkuUniqueness(skuInput);
  }

  // Cand se schimba optiunile variantei -> regenereaza SKU
  document.addEventListener('change', function(e) {
    if (!e.target.matches('select[name*="option_value_ids"]')) return;
    var topRow = e.target.closest('tr.variant-row-top');
    if (topRow) autoGenerateVariantSku(topRow);
  });

  // Tracking editare manuala SKU varianta + arata butonul Auto
  var variantSkuCheckTimers = {};

  document.addEventListener('input', function(e) {
    if (!e.target.matches('input.variant-sku')) return;
    variantSkuManualEdits[e.target.name] = true;
    var btn = e.target.closest('td').querySelector('.variant-sku-auto-btn');
    if (btn) btn.style.display = 'inline-block';

    // Debounced uniqueness check
    clearTimeout(variantSkuCheckTimers[e.target.name]);
    var input = e.target;
    variantSkuCheckTimers[input.name] = setTimeout(function() { checkVariantSkuUniqueness(input); }, 600);
  });

  // Blur pe SKU varianta -> check unicitate
  document.addEventListener('blur', function(e) {
    if (!e.target.matches('input.variant-sku')) return;
    if (e.target.value.trim()) checkVariantSkuUniqueness(e.target);
  }, true);

  // Verificare unicitate SKU varianta via AJAX + duplicat local in formular
  function checkVariantSkuUniqueness(input) {
    var sku = input.value.trim();
    var statusEl = input.closest('td').querySelector('.variant-sku-status');
    if (!sku || !statusEl) { if (statusEl) statusEl.style.display = 'none'; return; }

    // Check local duplicates first (other variant SKUs in the same form)
    var allSkuInputs = document.querySelectorAll('input.variant-sku');
    var localDuplicate = false;
    allSkuInputs.forEach(function(other) {
      if (other !== input && other.value.trim().toUpperCase() === sku.toUpperCase()) {
        // Check that the other variant is not destroyed
        var otherRow = other.closest('tr');
        if (otherRow && !otherRow.classList.contains('variant-destroyed')) {
          localDuplicate = true;
        }
      }
    });

    if (localDuplicate) {
      // Find next available suffix (-2, -3, etc.) that's unique both locally and not destroyed
      var baseSku = sku.replace(/-\d+$/, '');
      var counter = 2;
      var candidate;
      while (true) {
        candidate = baseSku + '-' + counter;
        var candidateTaken = false;
        allSkuInputs.forEach(function(other) {
          if (other !== input && other.value.trim().toUpperCase() === candidate.toUpperCase()) {
            var otherRow = other.closest('tr');
            if (otherRow && !otherRow.classList.contains('variant-destroyed')) {
              candidateTaken = true;
            }
          }
        });
        if (!candidateTaken) break;
        counter++;
      }
      input.value = candidate;
      statusEl.style.display = 'block';
      statusEl.style.color = '#dc8a00';
      statusEl.textContent = '\u26A0 SKU duplicat, sugerat: ' + candidate;
      // Also check the suggested SKU against the DB
      checkVariantSkuUniqueness(input);
      return;
    }

    var variantId = input.dataset.variantId || '';
    var productId = document.querySelector('input[name="product[id]"], form[action*="products/"] input[name="_method"]');
    // Extract product_id from form action URL
    var formEl = document.querySelector('form.product-form, form[action*="products"]');
    var pId = '';
    if (formEl) {
      var match = formEl.action.match(/products\/(\d+)/);
      if (match) pId = match[1];
    }

    var url = '/products/check_variant_sku?sku=' + encodeURIComponent(sku);
    if (variantId) url += '&variant_id=' + variantId;
    if (pId) url += '&product_id=' + pId;

    fetch(url)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        statusEl.style.display = 'block';
        if (data.available) {
          statusEl.style.color = '#28a745';
          statusEl.textContent = '\u2713 SKU disponibil';
        } else {
          input.value = data.sku;
          statusEl.style.color = '#dc8a00';
          statusEl.textContent = '\u26A0 SKU ocupat, sugerat: ' + data.sku;
        }
      })
      .catch(function() { statusEl.style.display = 'none'; });
  }

  // Click pe butonul Auto la varianta -> reset si regenereaza
  document.addEventListener('click', function(e) {
    if (!e.target.matches('.variant-sku-auto-btn')) return;
    var topRow = e.target.closest('tr.variant-row-top');
    if (!topRow) return;
    var skuInput = topRow.querySelector('input.variant-sku');
    if (skuInput) {
      delete variantSkuManualEdits[skuInput.name];
      e.target.style.display = 'none';
      var statusEl = topRow.querySelector('.variant-sku-status');
      if (statusEl) statusEl.style.display = 'none';
      autoGenerateVariantSku(topRow);
    }
  });

  // Cand se schimba numele produsului -> regenereaza SKU-uri variante (bazat pe nume)
  function regenerateAllVariantSkus() {
    var topRows = document.querySelectorAll('tr.variant-row-top:not(.variant-destroyed)');
    topRows.forEach(function(topRow) { autoGenerateVariantSku(topRow); });
  }

  nameField.addEventListener('input', function() { regenerateAllVariantSkus(); });
  skuField.addEventListener('input', function() { regenerateAllVariantSkus(); });
});
</script>
