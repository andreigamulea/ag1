<%= form_with(model: product, local: true, html: { multipart: true }) do |form| %>

  <% if product.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(product.errors.count, "error") %> prohibited this product from being saved:</h4>
      <ul>
        <% product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :name %>
    <%= form.text_field :name, class: "form-control" %>
  </div>

  <div>
    <%= form.label :slug %>
    <%= form.text_field :slug %>
  </div>

  <div>
    <%= form.label :description_title %>
    <%= form.text_field :description_title %>
  </div>

  <div>
    <%= form.label :description %>
    <%= form.text_area :description %>
  </div>

  <div>
    <%= form.label :price %>
    <%= form.number_field :price, step: 0.01 %>
  </div>

  <div>
    <%= form.label :cost_price %>
    <%= form.number_field :cost_price, step: 0.01 %>
  </div>

  <div>
    <%= form.label :discount_price %>
    <%= form.number_field :discount_price, step: 0.01 %>
  </div>

  <div>
    <%= form.label :sku %>
    <%= form.text_field :sku %>
  </div>

  <div>
    <%= form.label :stock %>
    <%= form.number_field :stock %>
  </div>

  <div>
    <%= form.label :track_inventory %>
    <%= form.check_box :track_inventory %>
  </div>

  <div>
    <%= form.label :stock_status %>
    <%= form.select :stock_status, Product.stock_statuses.keys.map { |k| [k.humanize, k] } %>
  </div>

  <div>
    <%= form.label :sold_individually %>
    <%= form.check_box :sold_individually %>
  </div>

  <div>
    <%= form.label :available_on %>
    <%= form.date_field :available_on %>
  </div>

  <div>
    <%= form.label :discontinue_on %>
    <%= form.date_field :discontinue_on %>
  </div>

  <div>
    <%= form.label :height %>
    <%= form.number_field :height, step: 0.01 %>
  </div>

  <div>
    <%= form.label :width %>
    <%= form.number_field :width, step: 0.01 %>
  </div>

  <div>
    <%= form.label :depth %>
    <%= form.number_field :depth, step: 0.01 %>
  </div>

  <div>
    <%= form.label :weight %>
    <%= form.number_field :weight, step: 0.01 %>
  </div>

  <div>
    <%= form.label :meta_title %>
    <%= form.text_field :meta_title %>
  </div>

  <div>
    <%= form.label :meta_description %>
    <%= form.text_field :meta_description %>
  </div>

  <div>
    <%= form.label :meta_keywords %>
    <%= form.text_field :meta_keywords %>
  </div>

  <div>
    <%= form.label :status %>
    <%= form.select :status, ["active", "inactive"] %>
  </div>

  <div>
    <%= form.label :featured %>
    <%= form.check_box :featured %>
  </div>

<div class="field">
  <%= form.label :requires_login, "Doar utilizatori logaÈ›i pot cumpÄƒra?" %>
  <%= form.check_box :requires_login %>
</div>

<div class="field">
  <%= form.label :product_type, "Tip produs" %>
  <%= form.select :product_type, Product.product_types.keys.map { |t| [t.titleize, t] } %>
</div>

<div class="field">
  <%= form.label :delivery_method, "Mod de livrare" %>
  <%= form.select :delivery_method, Product.delivery_methods.keys.map { |k| [k.titleize, k] } %>
</div>

<div class="field">
  <%= form.label :visible_to_guests, "Vizibil pentru utilizatori neautentificaÈ›i" %>
  <%= form.check_box :visible_to_guests %>
</div>


<div class="field">
  <%= form.label :taxable, "Se aplicÄƒ TVA" %>
  <%= form.check_box :taxable %>
</div>

<div class="field">
  <%= form.label :coupon_applicable, "Se aplicÄƒ cupon de reducere" %>
  <%= form.check_box :coupon_applicable %>
</div>


<!-- FiÈ™iere ataÈ™ate (ActiveStorage) -->
  <div class="mb-3">
    <%= form.label :attached_files, "FiÈ™iere ataÈ™ate" %>
    <%= form.file_field :attached_files, multiple: true, direct_upload: true, class: "form-control", id: "attached-files" %>
  </div>

  <% if product.persisted? && product.attached_files.attached? %>
    <div class="mb-3">
      <strong>FiÈ™iere existente:</strong>
      <ul>
        <% product.attached_files.each do |file| %>
          <li>
            <%= link_to file.filename.to_s, url_for(file), target: "_blank" %>
            <%= link_to "âœ•", purge_attached_file_product_path(product, file_id: file.id),
                        method: :delete,
                        data: { confirm: "Sigur vrei sÄƒ È™tergi acest fiÈ™ier?" },
                        class: "btn btn-sm btn-danger" %>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>




<div class="mb-3">
  <%= form.label :category_ids, "Categorii" %>
  <div id="category-options" class="d-flex flex-wrap gap-2 mb-2">
    <% Category.all.each do |category| %>
      <% selected = product.category_ids.include?(category.id) %>
      <span class="badge category-badge <%= selected ? 'bg-primary' : 'bg-secondary' %> text-white"
            data-id="<%= category.id %>"
            style="cursor: pointer;">
        <%= category.name %>
      </span>
    <% end %>
  </div>

  <div id="category-hidden-inputs">
    <!-- Input ascuns gol pentru a trimite category_ids ca [] -->
    <input type="hidden" name="product[category_ids][]" value="">
    <% product.category_ids.each do |cat_id| %>
      <input type="hidden" name="product[category_ids][]" value="<%= cat_id %>">
    <% end %>
  </div>
</div>





<button type="button" onclick="testPresign()">TesteazÄƒ presign</button>






 <div class="mb-3">
  <%= form.label :custom_attributes, "Atribute personalizate (JSON)", class: "form-label" %>
  <%= form.text_area :custom_attributes, class: "form-control", rows: 5 %>
</div>



 

  <!-- Imagine principalÄƒ (upload direct BunnyCDN) -->
  <div class="mb-3">
    <label for="bunny-direct-upload">Imagine principalÄƒ (direct Bunny)</label>
    <input type="file" id="bunny-direct-upload" class="form-control" accept="image/*" />
    <input type="hidden" name="product[external_image_url]" id="external_image-url" />
    <% if @product.external_image_url.present? %>
  <div class="bunny-preview" data-type="main">
    <img src="<%= @product.external_image_url %>" class="img-thumbnail" style="max-height: 150px;">
    <button type="button" class="btn btn-sm btn-danger remove-bunny-image" data-target="main">Ã—</button>
  </div>
<% end %>

  </div>

  <!-- Imagini secundare -->
  <div class="mb-3">
    <label for="bunny-secondary-upload">Imagini secundare (direct Bunny)</label>
    <input type="file" id="bunny-secondary-upload" class="form-control" multiple accept="image/*" />
    <div id="bunny-secondary-preview" class="mt-2 d-flex flex-wrap gap-2"></div>
    <% if @product.external_image_urls.present? %>
    <div class="bunny-thumbs">
      <% @product.external_image_urls.each_with_index do |url, index| %>
        <div class="bunny-preview" data-index="<%= index %>">
          <img src="<%= url %>" class="img-thumbnail" style="max-height: 120px;">
          <button type="button" class="btn btn-sm btn-danger remove-bunny-image" data-target="secondary" data-index="<%= index %>">Ã—</button>
        </div>
      <% end %>
    </div>
  <% end %>

  </div>

  <!-- Atribute personalizate -->
  <div class="mb-3">
    <%= form.label :custom_attributes, "Atribute personalizate (JSON)" %>
    <%= form.text_area :custom_attributes, class: "form-control", rows: 5 %>
  </div>

  <%= form.submit "SalveazÄƒ produsul", class: "btn btn-primary" %>
<% end %>

<script>
document.addEventListener("turbo:load", () => {
  const input = document.getElementById("secondary-images");
  const wrapper = document.getElementById("image-badges-wrapper");
  const form = document.querySelector("form");
  const maxSize = 5 * 1024 * 1024; // 5 MB
  const maxFiles = 10; // Maxim 10 imagini secundare

  let allFiles = [];

  input.addEventListener("change", () => {
    const newFiles = Array.from(input.files);

    // Validare dimensiune È™i numÄƒr
    if (allFiles.length + newFiles.length > maxFiles) {
      alert(`PoÈ›i Ã®ncÄƒrca maxim ${maxFiles} imagini secundare.`);
      input.value = "";
      return;
    }

    newFiles.forEach(file => {
      if (file.size > maxSize) {
        alert(`FiÈ™ierul ${file.name} este prea mare. Dimensiunea maximÄƒ este 5MB.`);
      } else if (!allFiles.some(f => f.name === file.name && f.size === file.size)) {
        allFiles.push(file);
      }
    });

    renderBadges();
    input.value = ""; // ResetÄƒm pentru a permite reÃ®ncÄƒrcarea aceleiaÈ™i imagini

    // Refacem input.files
    const dt = new DataTransfer();
    allFiles.forEach(file => dt.items.add(file));
    input.files = dt.files;
  });

  function renderBadges() {
    wrapper.innerHTML = "";
    allFiles.forEach((file, index) => {
      const badge = document.createElement("span");
      badge.className = "badge bg-primary text-white me-2 mb-2";
      badge.innerHTML = `${file.name} <span onclick="removeFile(${index})" style="cursor:pointer; margin-left:6px;">Ã—</span>`;
      wrapper.appendChild(badge);
    });
  }

  window.removeFile = function(index) {
    allFiles.splice(index, 1);
    renderBadges();
    const dt = new DataTransfer();
    allFiles.forEach(file => dt.items.add(file));
    input.files = dt.files;
  };
});
</script>

<script>
document.addEventListener("turbo:load", () => {
  const badges = document.querySelectorAll(".category-badge");
  const hiddenInputsWrapper = document.getElementById("category-hidden-inputs");

  badges.forEach(badge => {
    badge.addEventListener("click", () => {
      const id = badge.dataset.id;
      const existingInputs = hiddenInputsWrapper.querySelectorAll(`input[value='${id}']`);

      if (existingInputs.length > 0) {
        existingInputs.forEach(input => input.remove());
        badge.classList.remove("bg-primary");
        badge.classList.add("bg-secondary");
      } else {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "product[category_ids][]";
        input.value = id;
        hiddenInputsWrapper.appendChild(input);
        badge.classList.remove("bg-secondary");
        badge.classList.add("bg-primary");
      }
    });
  });
});
</script>

<script>
document.addEventListener("turbo:load", () => {
  const form = document.querySelector("form");

  // === Upload imagine principalÄƒ ===
  const mainInput = document.getElementById("bunny-direct-upload");
  if (mainInput) {
    mainInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const res = await fetch(`/uploads/presign?filename=${encodeURIComponent(file.name)}`);
        const { upload_url, headers } = await res.json();

        const upload = await fetch(upload_url, {
          method: "PUT",
          headers: {
            "Content-Type": headers["Content-Type"],
            "AccessKey": headers["AccessKey"] // ðŸ”¥ esenÈ›ial
          },
          body: file
        });

        if (upload.ok) {
          const cdnUrl = upload_url.replace("storage.bunnycdn.com", "ayus-cdn.b-cdn.net").split("?")[0];
          document.getElementById("external_image-url").value = cdnUrl;
        } else {
          alert("Eroare la upload imagine principalÄƒ.");
          console.error("Upload error:", upload.status, await upload.text());
        }
      } catch (err) {
        alert("Eroare la comunicare cu serverul.");
        console.error(err);
      }
    });
  }

  // === Upload imagini secundare ===
  const secondaryInput = document.getElementById("bunny-secondary-upload");
  const preview = document.getElementById("bunny-secondary-preview");

  if (secondaryInput) {
    secondaryInput.addEventListener("change", async () => {
      for (const file of secondaryInput.files) {
        try {
          const res = await fetch(`/uploads/presign?filename=${encodeURIComponent(file.name)}`);
          const { upload_url, headers } = await res.json();

          const upload = await fetch(upload_url, {
            method: "PUT",
            headers: {
              "Content-Type": headers["Content-Type"],
              "AccessKey": headers["AccessKey"]
            },
            body: file
          });

          if (upload.ok) {
            const cdnUrl = upload_url.replace("storage.bunnycdn.com", "ayus-cdn.b-cdn.net").split("?")[0];

            const img = document.createElement("img");
            img.src = cdnUrl;
            img.width = 100;
            img.classList.add("img-thumbnail", "me-2");
            preview.appendChild(img);

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "product[external_image_urls][]";
            hidden.value = cdnUrl;
            form.appendChild(hidden);
          } else {
            alert(`Eroare la upload pentru ${file.name}`);
            console.error("Upload error:", upload.status, await upload.text());
          }
        } catch (err) {
          alert(`Eroare la comunicare pentru ${file.name}`);
          console.error(err);
        }
      }
    });
  }
});
</script>









<script>
  function testPresign() {
    fetch("/uploads/presign?filename=test_bunny.png")
      .then(response => response.json())
      .then(data => console.log("Presign OK:", data))
      .catch(error => console.error("Eroare:", error));
  }
</script>
